<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/app-layout/app-layout.html">
<link rel="import" href="/bower_components/app-layout/app-scroll-effects/effects/waterfall.html">

<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-image/iron-image.html">
<link rel="import" href="/bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="/bower_components/iron-scroll-target-behavior/iron-scroll-target-behavior.html">
<link rel="import" href="/bower_components/iron-swipeable-pages/iron-swipeable-pages.html">

<link rel="import" href="/bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-menu/paper-menu.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="/bower_components/paper-styles/typography.html">
<link rel="import" href="/bower_components/paper-styles/color.html">
<link rel="import" href="/bower_components/paper-styles/shadow.html">

<link rel="import" href="/bower_components/neon-animation/neon-animations.html"><!-- Pick only nescessary ones -->
<link rel="import" href="/bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="/bower_components/neon-animation/neon-shared-element-animatable-behavior.html">

<link rel="import" href="yta-firebase.html">
<link rel="import" href="yta-overview-page.html">

<link rel="import" href="yta-common-styles.html">

<dom-module id="yta-main-view">
  <template>
    <style include="yta-common-styles">
    
      @media (min-width: 480px) and (max-width: 960px) and (orientation: landscape), (min-width: 0px) and (max-width: 600px) and (orientation: portrait) {
        
        /* Phone styles */
         
        #fab {
          position: fixed;
          bottom: 16px;
          right: 16px;
        }
        
      }
      
      @media (min-width: 601px) and (max-width: 840px) and (orientation: portrait), (min-width: 961px) and (max-width: 1279px) and (orientation: landscape) {
        
        /* Tablet styles */ /* A bit wider than standart tablet */
         
        #fab {
          position: fixed;
          right: 24px;
          bottom: 24px;
        }
        
      }
      
      @media (min-width: 1280px) and (orientation: landscape) {
        
        paper-tabs {
          padding: 0 180px !important;
        }
        
        #fab {
          position: fixed;
          top: 96px;
          right: 52px;
        }
        
      }
      
      /* Cross-device styles */
      
      hr {
        border-width: 1px 0 0 0;
        border-color: var(--divider-color);
      }
      
      iron-swipeable-pages {
        @apply(--layout-fit);
      }
      
      app-drawer {
        --app-drawer-content-container: {
          @apply(--shadow-elevation-16dp);
          /* @note 
          Those two values should only apply on mobile.
          However, the drawer shows only on mobile so to speed
          up the page they're included in cross-platform styles
          */
          max-width: 280px;
          width: calc(100% - 56px);
        }
      }
      
      app-toolbar {
        background-color: var(--primary-color);
        color: white;
        /* opacity: var(--light-primary-opacity) # No need to include this since it defaults to 1 */
      }
      
      [title] {
        @apply(--paper-font-title);
      }
      
      paper-menu > paper-item {
        --paper-item-selected-weight: 400 !important;
        --paper-item-focused-before: {
          background: var(--light-theme-secondary-color) !important;
        };
      }
      paper-menu > paper-item:focus:after {
        background: none !important;
      }
      
      #fab {
        @apply(--shadow-transition);
        color: black;
        --paper-fab-iron-icon: {
          opacity: var(--dark-primary-opacity);
        };
        --paper-fab-keyboard-focus-background: var(--dark-accent-color);
      }
      
      /* From http://stackoverflow.com/questions/1495407/maintain-the-aspect-ratio-of-a-div-with-css */
      #ratioContainer {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%;
        border-bottom: 1px solid var(--divider-color);
        margin-bottom: 8px;
      }
      
      #ratioContainer > iron-image {
        @apply(--layout-fit);
        background-color: var(--paper-deep-purple-100);
      }
      
      #ratioContainer > div:not([scrim]) {
        @apply(--layout-horizontal);
        height: 56px;
        color: #FFFFFF; /* From https://material.google.com/patterns/navigation-drawer.html#navigation-drawer-specs */
        position: absolute;
        left: 16px;
        right: 16px;
        bottom: 8px;
      }
      #ratioContainer > div:not([scrim]) > div {
        @apply(--layout-self-center);
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }
      #ratioContainer > div:not([scrim]) > paper-menu-button {
        @apply(--layout-self-end);
        left: 16px; /* How the hell are those two properties working? */
        top: 8px;
      }
      #ratioContainer > div:not([scrim]) > div > div:not([secondary]) { 
        @apply(--paper-font-body2);
      }
      #ratioContainer > div:not([scrim]) > div > div[secondary] {
        @apply(--paper-font-body1);
      }
      #ratioContainer > div[scrim] {
        @apply(--layout-fit);
        /* Genrated using http://www.cssmatic.com/gradient-generator */
        background: rgba(0,0,0,0);
        background: -moz-linear-gradient(top, rgba(0,0,0,0) 0%, rgba(0,0,0,0.2) 70%, rgba(0,0,0,0.4) 100%);
        background: -webkit-gradient(left top, left bottom, color-stop(0%, rgba(0,0,0,0)), color-stop(70%, rgba(0,0,0,0.2)), color-stop(100%, rgba(0,0,0,0.4)));
        background: -webkit-linear-gradient(top, rgba(0,0,0,0) 0%, rgba(0,0,0,0.2) 70%, rgba(0,0,0,0.4) 100%);
        background: -o-linear-gradient(top, rgba(0,0,0,0) 0%, rgba(0,0,0,0.2) 70%, rgba(0,0,0,0.4) 100%);
        background: -ms-linear-gradient(top, rgba(0,0,0,0) 0%, rgba(0,0,0,0.2) 70%, rgba(0,0,0,0.4) 100%);
        background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.2) 70%, rgba(0,0,0,0.4) 100%);
      }
      #ratioContainer > iron-image.avatar {
        position: absolute;
        top: 15px;
        left: 15px;
        height: 64px;
        width: 64px;
        border-radius: 50%;
      }
      
      #drawerMenusContainer > paper-menu > paper-item > iron-icon {
        padding-right: 32px;
        vertical-align: middle;
      }
      #drawerMenusContainer > paper-menu > paper-item:not(.iron-selected) > iron-icon {
        color: var(--secondary-text-color);
      }
      
      #drawerMenusContainer > paper-menu > paper-item {
        font-weight: 500 !important;
        color: var(--primary-text-color);
        --paper-item-selected-weight: 500 !important;
        --paper-item-selected: {
          color: var(--primary-color) !important;
        };
      }
      
      iron-swipeable-pages > div {
        background-color: var(--primary-body-color);
      }
      
      iron-swipeable-pages > div > * {
        @apply(--layout-fit);
      }
      
      iron-swipeable-pages > div > .waiter {
        @apply(--layout-fit);
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-center-justified);
        background-color: var(--primary-body-color);
      }
      
      iron-swipeable-pages > div > .waiter > paper-spinner {
        --paper-spinner-stroke-width: 4px;
        position: relative;
        width: 44px;
        height: 44px;
      }
      
    </style>
    
    <yta-firebase data="{{data}}" user="{{user}}"></yta-firebase>
    
    <app-header id="header" fixed shadow>
      <app-toolbar>
        <paper-icon-button icon="menu" hidden$="[[!phoneLayout]]" on-tap="_toggleDrawer"></paper-icon-button>
        <div title>Your Timetable</div>
        <paper-menu-button hidden$="[[phoneLayout]]" horizontal-align="right">
          <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
          <paper-menu class="dropdown-content">
            <paper-item on-tap="_openSettings" role="menuitem">Settings</paper-item>
            <paper-item on-tap="_sendFeedback"role="menuitem">Feedback</paper-item>
            <paper-item on-tap="signOut" role="menuitem">Sign out</paper-item>
            <!--<paper-item role="menuitem">Help</paper-item> # Think of help section -->
          </paper-menu>
        </paper-menu-button>
      </app-toolbar>
      <template is="dom-if" if="[[!phoneLayout]]" restamp>
        <app-toolbar>
          <paper-tabs selected="{{selected}}" attr-for-selected="key" bottom-item>
            <paper-tab key="overview">overview</paper-tab>
            <paper-tab key="timetable">timetable</paper-tab>
            <paper-tab key="teachers">teachers</paper-tab>
            <paper-tab key="calendar">calendar</paper-tab>
          </paper-tabs>
        </app-toolbar>
      </template>
    </app-header>
    
    <paper-fab id="fab" icon="add" on-tap="_openAddDialog"></paper-fab>
    
    <iron-swipeable-pages id="pages"
                          edge-swipe-sensitivity="30"
                          selected="{{selected}}"
                          attr-for-selected="id">
      <div id="overview">
        <yta-overview-page phone-layout="[[phoneLayout]]" data="[[data]]" scroll-target="document"></yta-overview-page>
        <div class="waiter">
          <paper-spinner active></paper-spinner>
        </div>
      </div>
      <div id="timetable">
        <yta-timetable-page data="[[data]]" scroll-target="document"></yta-timetable-page>
        <div class="waiter">
          <paper-spinner active></paper-spinner>
        </div>
      </div>
      <div id="teachers">
        <yta-teachers-page scroll-target="document"></yta-teachers-page>
        <div class="waiter">
          <paper-spinner active></paper-spinner>
        </div>
      </div>
      <div id="calendar">
        <yta-calendar-page scroll-target="document"></yta-calendar-page>
        <div class="waiter">
          <paper-spinner active></paper-spinner>
        </div>
      </div>
    </iron-swipeable-pages>
    
    <template is="dom-if" restamp if="[[phoneLayout]]">
      <app-drawer id="drawer" swipe-open>
        <div id="ratioContainer">
          <iron-image src="/images/paper-backdrop.png" fade preload sizing="contain"></iron-image>
          <div scrim></div>
          <iron-image fade preload src="[[user.photoURL]]" sizing="contain" class="avatar"></iron-image>
          <div>
            <div>
              <div>[[user.displayName]]</div>
              <div secondary>[[user.email]]</div>
            </div>
            <paper-menu-button horizontal-align="right">
              <paper-icon-button icon="arrow-drop-down" class="dropdown-trigger"></paper-icon-button>
              <paper-menu class="dropdown-content">
                <paper-item on-tap="signOut" role="menuitem">Sign out</paper-item>
              </paper-menu>
            </paper-menu-button>
          </div>
        </div>
        <div id="drawerMenusContainer">
          <paper-menu selected="{{selected}}" on-tap="_closeDrawer" attr-for-selected="key">
            <paper-item key="overview" role="menuitem"><iron-icon icon="home"></iron-icon>Overview</paper-item>
            <paper-item key="timetable" role="menuitem"><iron-icon icon="timeline"></iron-icon>Timetable</paper-item>
            <paper-item key="teachers" role="menuitem"><iron-icon icon="account-balance"></iron-icon>Teachers</paper-item>
            <paper-item key="calendar" role="menuitem"><iron-icon icon="event"></iron-icon>Calendar</paper-item>
          </paper-menu>
          <hr noshade>
          <paper-menu on-tap="_closeDrawer" activate-event="">
            <paper-item on-tap="_openSettings" role="menuitem"><iron-icon icon="settings"></iron-icon>Settings</paper-item>
            <paper-item on-tap="_sendFeedback" role="menuitem"><iron-icon icon="feedback"></iron-icon>Send feedback</paper-item>
            <!--<paper-item key="calendar" role="menuitem"><iron-icon icon="help"></iron-icon>Help</paper-item> # Think of help section -->
          </paper-menu>
        </div>
      </app-drawer>
    </template>
  </template>
  
  <script>
    Polymer({
      is: 'yta-main-view',
      
      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior,
        Polymer.NeonAnimationRunnerBehavior,
        Polymer.IronResizableBehavior,
        Polymer.IronScrollTargetBehavior
      ],
      
      properties: {
        
        phoneLayout: {
          type: Boolean,
          notify: true
        },
        
        selected: {
          type: String,
          notify: true,
          value: 'overview',
          observer: 'resolveSelected'
        },
        
        data: {
          type: Object,
          notify: true,
          observer: '_loadOverviewPage'
        },
        
        user: {
          type: Object,
          notify: true,
          value: function() { return {
            displayName: 'Your name',
            email: 'you@example.com',
            photoURL: 'https://placehold.it/64?text=You',
            isDefault: true
          } }
          
        },
        
        animationConfig: {
          value: function() { return {
            'ready': [
              {
                name: 'fade-in-animation',
                node: this.$.pages,
                timing: {
                  duration: 500,
                  easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
                }
              },
              {
                name: 'scale-up-animation',
                node: this.$.fab,
                timing: {
                  duration: 500,
                  easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
                }
              },
              {
                name: 'slide-from-top-animation',
                node: this.$.header,
                timing: {
                  duration: 500,
                  easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
                }
              }
            ],
            'fadeOut': {
              name: 'fade-out-animation'
            }
          } }
        }
        
      },
      
      listeners: {
        'iron-resize': 'setLayout', // To set the layout when screen size changes
      },
      
      attached: function() {
        appmain = this;
        this.setLayout();
        this.playAnimation('ready');
        shell.checkForTargets().then(target => {
          this.selected = target;
        }, err => {
          if(err != 'no targets' && err != 'invalid target') {
            console.error(err)
          }
        })
      },
      
      setLayout: function() {
        // Fix app-layout
        let screenSpace = window.innerHeight - this.$.header.offsetHeight + 'px';
        let headerHeigh = this.$.header.offsetHeight + 'px';
        let pages = this.root.querySelectorAll('#pages, #pages :not(paper-spinner)');
        this.$.pages.style.paddingTop = headerHeigh;
        pages = Array.prototype.slice.call(pages);
        pages.forEach(item => {
          item.style.height = screenSpace;
        })
      },
      
      signOut: function() {
        firebaseControl.signOut();
      },
      
      resolveSelected: function(selectedString) {
        if(selectedString != 'overview') {
          selectedItemWaiter = this.$$(['#', selectedString, ' > .waiter'].join(''));
          if(!selectedItemWaiter.hidden) {
            this.importHref(['/src/yta', selectedString, 'page.html'].join('-'), () => {
              this.set('animationConfig.fadeOut.node', selectedItemWaiter);
              this.listen(appmain, 'neon-animation-finish', '_hideSelectedItemWaiter');
              this.playAnimation('fadeOut');
            }, null, true);
          }
        }
      },
      
      _openAddDialog: function() {
        this.fire('switch-page', { action: 'openAddDialog' });
      },
      
      _hideSelectedItemWaiter: function() {
        selectedItemWaiter.hidden = true;
        this.unlisten(this, 'neon-animation-finish', '_hideSelectedItemWaiter')
      },
      
      _toggleDrawer: function(e) {
        this.$$('app-drawer').toggle()
      },
      
      _sendFeedback: function() {
        console.log('Feedback request sent');
        this.fire('send-feedback');
      },
      
      _openSettings: function() {
        console.log('Open settings request sent');
        this.fire('open-settings');
      },
      
      _closeDrawer: function() {
        this.$$('#drawer').close()
      },
      
      _loadOverviewPage: function(data) {
        const overviewPage = this.$$('#overview yta-overview-page');
        selectedItemWaiter = this.$$('#overview > .waiter');
        if(!selectedItemWaiter.hidden) {
          this.importHref('src/yta-overview-page.html', () => {
            this.set('animationConfig.fadeOut.node', selectedItemWaiter);
            this.listen(appmain, 'neon-animation-finish', '_hideSelectedItemWaiter');
            this.playAnimation('fadeOut');
          }, null, true);
        }
      }
    })
  </script>
</dom-module>