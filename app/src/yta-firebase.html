<!-- This component is built on ES6 and might not work everywhere -->

<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="yta-firebase">
  <script>
    Polymer({
      is: 'yta-firebase',
      
      properties: {
        
        user: {
          type: Object,
          notify: true
        },
        
        data: {
          type: Object,
          notify: true
        },
        
        _firstLoadDone: {
          type: Boolean,
          value: false
        }
        
      },
      
      attached: function() {
        firebaseControl = this;
        this._downloadSDKs().then(() => {
          firebase.auth().onAuthStateChanged(user => {
            this._checkUser(user);
          });
          document.addEventListener('visibilitychange', () => {
            document.hidden ? firebase.goOffline:
                              firebase.goOnline;
          })
        })
      },
      
      signIn: function() {
        return firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider())
      },
      
      signOut: function() {
        var output;
        if(this.user.isAnonymous) {
          output = firebase.auth().currentUser.delete()
        } else {
          output = firebase.auth().signOut()
        };
        return output
          .then(() => {
            // Delete PouchDB
            location.reload()
          })
          .catch(err => {
            console.warn('Sign out failed', err)
          })
      },
      
      isFirstTimeVisit: function() {
        return new Promise((resolve, reject) => {
          this._checkUser().then(user => {
            if(user.isDefault) {
              reject(Error('No user signed in!'))
            };
            firebase.database().ref(['users', user.uid].join('/')).once('value', snapshot => {
              if(snapshot.val()) {
                resolve(false)
              } else {
                resolve(true)
              }
            })
          })
        });
      },
      
      signInAnonymously: function() {
        return firebase.auth().signInAnonymously();
      },
      
      _checkUser: function(user = firebase.auth().currentUser) {
        return new Promise((resolve, reject) => {
          if (user) {
            // User is signed in.
            if(!user.isAnonymous) {
              this.user = user
            } else {
              var output = this.user;
              output.isAnonymous = true;
              output.uid = user.uid;
              output.isDefault = false;
              this.user = output
            }
          } else {
            // No user is signed in.
            this.fire('switch-page', { action: 'openOnboarding' });
          };
          resolve(user);
        })
      },
      
      _downloadSDKs: function() {
        function downloadPouchDB() {
          return new Promise((resolve, reject) => {
            var script = document.createElement('script');
            script.src = 'bower_components/pouchdb/dist/pouchdb.min.js';
            script.onload = function () {
              resolve()
            };
            document.head.appendChild(script);
          })
        };
        
        var p1 = new Promise((resolve, reject) => {
          var script = document.createElement('script');
          script.src = 'https://www.gstatic.com/firebasejs/3.1.0/firebase-app.js';
          script.onload = function () {
            resolve()
          };
          document.head.appendChild(script);
        });
        var p2 = new Promise((resolve, reject) => {
          var script = document.createElement('script');
          script.src = 'https://www.gstatic.com/firebasejs/3.1.0/firebase-auth.js';
          script.onload = function () {
            resolve()
          };
          document.head.appendChild(script);
        });
        var p3 = new Promise((resolve, reject) => {
          var script = document.createElement('script');
          script.src = 'https://www.gstatic.com/firebasejs/3.1.0/firebase-database.js';
          script.onload = function () {
            resolve();
          };
          document.head.appendChild(script);
        });
        var p4 = new Promise((resolve, reject) => {
          if ('serviceWorker' in navigator && 'SyncManager' in window) {
            navigator.serviceWorker.ready.then(reg => {
              resolve();
              // return reg.sync.register('firstSync');
            }).catch(() => {
              downloadPouchDB().then(() => resolve());
            });
          } else {
            // serviceworker/sync not supported
            downloadPouchDB().then(() => resolve());
          }
        });
        
        return Promise.all([p1, p2, p3, p4]).then(() => {
          var config = {
            apiKey: "AIzaSyDaMune3u4WZMti3aB66FWjX9aA_lWTLkQ",
            authDomain: "your-timetable.firebaseapp.com",
            databaseURL: "https://your-timetable.firebaseio.com"
          };
          firebase.initializeApp(config);
        });
      }
    });
  </script>
</dom-module>