<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-pouchdb/app-pouchdb-document.html">

<link rel="import" href="firebase-auth.html"><!-- A little hack -->
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<dom-module id="yta-firebase">
  <template>
    <style>
      :host { display: none; }
    </style>
    
    <app-pouchdb-document id="cache"
                          db-name="your-timetable"
                          doc-id="[[user.uid]]"
                          data="{{cachedData}}"></app-pouchdb-document>
    
    <!--<firebase-app auth-domain="your-timetable.firebaseapp.com"
                  database-url="https://your-timetable.firebaseio.com"
                  api-key="AIzaSyDaMune3u4WZMti3aB66FWjX9aA_lWTLkQ"></firebase-app>
    <firebase-auth id="auth" 
                   user="{{user}}"
                   status-known="{{authLoaded}}"
                   provider="google"></firebase-auth>
    <firebase-document id="timetable"
                       path="/users/[[user.uid]]/timetable"
                       data="{{fData.timetable}}"></firebase-document>
    <firebase-document id="lessons"
                       path="/users/[[user.uid]]/lessons"
                       data="{{fData.lessons}}"></firebase-document>
    <firebase-document id="settings"
                       path="/users/[[user.uid]]/settings"
                       data="{{fData.settings}}"></firebase-document>-->

</firebase-document>
  </template>
  
  <script>
    Polymer({
      is: 'yta-firebase',
      
      properties: {
        
        user: {
          type: Object,
          notify: true
        },
        
        authLoaded: {
          type: Object,
          notify: true,
          value: false,
          observer: '_authLoaded'
        },
        
        data: {
          type: Object,
          notify: true
        },
        
        cachedData: {
          type: Object,
          notify: true,
          value: function() { return {
            lastEdit: 0
          } }
        },
        
        fData: {
          type: Object,
          notify: true,
          value: function() { return {} }
        },
        
        _firstLoadDone: {
          type: Boolean,
          value: false
        }
        
      },
      
      observers: [
        
      ],
      
      attached: function() {
        firebaseControl = this;
      },
      
      /*firstLoadData: function() {
        localLastEdit = this.cachedData.lastEdit;
        this.querySelector('firebase-app').app.database()
        .ref(['users', this.user.uid, 'lastEdit'].join('/'))
        .once('value', function(snapshot) { cloudLastEdit = snapshot.val() })
        .then(function() {
          if( cloudLastEdit >= localLastEdit ) {
            firebaseControl.data = firebaseControl.fData;
            firebaseControl.cachedData = firebaseControl.fData;
            firebaseControl.set('cachedData.lastEdit', new Date().getTime());
            firebaseControl.$.cache.save()
          } else {
            firebaseControl.data = firebaseControl.cachedData;
            firebaseControl.cacheToCloud()
          }
        })
      },*/
      
      signIn: function() {
        this.$.auth.signInWithPopup()
          .then(function(response) {
            //..
          })
          .catch(function(error) {
            //..
          });
      },
      
      signOut: function() {
        this.$.auth.signOut()
          .then(function(response) {
            //..
          })
          .catch(function(error) {
            //..
          });
      },
      
      /*cacheToCloud: function() {
        this.querySelector('firebase-app').app.database()
        .ref(['users', this.user.uid].join('/'))
        .set(this.cachedData);
      },*/
      
      _authLoaded: function(loaded) {
        if(loaded) {
          if(this.user.isDefault) {
            console.log('Not logged in, opening onboarding');                   // Use of console.log()
            this.importHref('src/yta-onboarding.html', function() {
              this.fire('switch-page', { action: 'openOnboarding' });
            }, null, true);
          } else {
            this.firstLoadData();
          }
        }
      }
    });
  </script>
</dom-module>