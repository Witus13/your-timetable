<link rel="import" href="/bower_components/polymer/polymer-element.html">

<link rel="import" href="/bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="/bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-styles/paper-styles.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="app-localize-behavior-mixin.html">


<dom-module id="yta-settings">
  <template>
    <style>

      @media (min-width: 480px) and (max-width: 960px) and (orientation: landscape), (min-width: 0px) and (max-width: 600px) and (orientation: portrait) {
        /* Phone styles */
        
        #main {
          position: absolute;
          top: 0;
          bottom: 0;
          right: 0;
          left: 0;
        }

        #content {
          position: absolute;
          top: 56px;
          bottom: 0;
          left: 0;
          right: 0;
        }

        app-toolbar {
          height: 56px;
          padding-left: 8px;
        }
        
        app-toolbar [title] {
          margin-left: 24px;
        }
      }

      @media (min-width: 480px) and (max-width: 960px) and (orientation: landscape) {
        /* Phone landscape styles */
        
        #main {
          position: absolute;
          top: 0;
          bottom: 0;
          right: 0;
          left: 0;
        }

        #content {
          position: absolute;
          top: 48px;
          bottom: 0;
          left: 0;
          right: 0;
        }

        app-toolbar {
          height: 48px !important;
        }
      }
      
      @media (min-width: 601px) and (max-width: 840px) and (orientation: portrait), (min-width: 961px) and (max-width: 1279px) and (orientation: landscape) {
        /* Tablet styles */ /* A bit wider than standart tablet */
        
        #main {
          position: absolute;
          top: 0;
          bottom: 0;
          right: 0;
          left: 0;
        }

        #content {
          position: absolute;
          top: 64px;
          bottom: 0;
          left: 0;
          right: 0;
        }

        /* app-toolbar {
          height: 64px; # Not nescessary since this is the default
        } */
      }
      
      @media (min-width: 841px) and (orientation: portrait), (min-width: 1280px) and (orientation: landscape) {
        /* Desktop styles */
        
        :host {
          @apply --layout;
          @apply --layout-center;
          @apply --layout-center-justified;
        }
        
        #main {
          width: 750px;
          height: 750px;
          position: relative;
        }

        #content {
          height: 686px;
        }

        app-toolbar {
          /*height: 64px; # Not nescessary since this is the default*/
          padding: 0 8px 0 60px;
        }

        #main {
          @apply --shadow-elevation-16dp;
        }
        
        #main, .page {
          border-radius: 25px;
        }

        app-toolbar, app-header {
          border-top-left-radius: 25px;
          border-top-right-radius: 25px;
        }
        
        /* Hide ugly scrollbar in Chrome on desktop */
        #main::-webkit-scrollbar { width: 0 !important; }
      }

      :host {
        @apply --layout-fit;
        transform: translateY(100vh);
        background: rgba(0, 0, 0, 0.3);
        z-index: 999;
        @apply --paper-font-common-base;
      }

      :host(.open) {
        transform: none;
      }

      #content {
        background-color: white;
        padding: 15px;
        overflow-y: scroll;
      }

      app-header {
        background-color: #263238;
        color: white;
        z-index: 1;
      }

    </style>

    <div id="main">
      <app-header shadow fixed>
        <app-toolbar>
          <paper-icon-button icon="back-arrow" on-tap="_sendClose"></paper-icon-button>
          <div main-title class="spacer">[[localize('set_h')]]</div>
        </app-toolbar>
      </app-header>
      <div id="content">
        <paper-dropdown-menu label="[[localize('set_lang')]]">
          <paper-listbox slot="dropdown-content" attr-for-selected="key" fallback-selection="en" selected="{{language}}">
            <paper-item key="en">English</paper-item>
            <paper-item key="pl">Polski</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-toggle-button checked="{{appData.settings.use12hoursClock}}">[[localize('set_12h')]]</paper-toggle-button>
        <paper-dropdown-menu label="[[localize('set_firstDay')]]">
          <paper-listbox slot="dropdown-content" attr-for-selected="i" selected="{{appData.settings.firstDayOfWeek}}">
            <paper-item i="1">[[localize('weekDays','d','1')]]</paper-item>
            <paper-item i="6">[[localize('weekDays','d','6')]]</paper-item>
            <paper-item i="0">[[localize('weekDays','d','0')]]</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>
    </div>
  </template>

  <script>
    class Settings extends Polymer.AppLocalizeBehaviorMixin(Polymer.Element) {
      static get is() { return 'yta-settings'; }
      static get properties() {
        return {
          
          // User data
          appData: {
            type: Object,
            notify: true
          },

          // Inherited from shell
          desktopLayout: {
            type: Boolean
          },
          
          // Inherited from shell
          tabletLayout: {
            type: Boolean
          },

          language: {
            value: () => window.appLang,
            observer: '_langChanged'
          },

        };
      }

      constructor() {
        super();
      }

      connectedCallback() {
        super.connectedCallback();

        // Complicated? parentElement is neon-animated-pages, parentNode is ShadowRoot and we need it's host
        //              But if it's not Shadow DOM, pick just parentElement
        if (!this._shell) this._shell = Polymer.Settings.useShadow ? this.parentElement.parentNode.host
                                                                   : this.parentElement.parentElement;

        // Add event listeners
        this._shell.addEventListener('open-settings', () => this.open());
        this._shell.addEventListener('close-settings', () => this.close());
      }

       open() {
        document.head.querySelector('#themeColor').setAttribute('content', '#263238');
        this.style.transition = 'transform 200ms ease-out';
        this._computeTransitionTimes();
        Polymer.RenderStatus.afterNextRender(this, () => { 
          this.classList.add('open');
        });
      }
      
      close() {
        document.head.querySelector('#themeColor').setAttribute('content', '#673ab7');
        this.style.transition = 'transform 200ms ease-in';
        this._computeTransitionTimes();
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            this.classList.remove('open');
          });
        });
      }

      _sendClose() {
        this._fire('switch-page', { action: 'closeSettings' }, false, this._shell);
      }

      _langChanged(language) {
        window.appLang = language;
      }

      _computeTransitionTimes() {
        if (this._lastTransTimeChange &&
            this._lastTransTimeChange[0] === this.tabletLayout &&
            this._lastTransTimeChange[1] === this.desktopLayout)
        {
          return;
        }
        if (this.tabletLayout) {
          this.style.transitionDuration = '260ms';
        } else if (this.desktopLayout) {
          this.style.transitionDuration = '150ms';
        } else {
          this.style.transitionDuration = '200ms';
        }
        this._lastTransTimeChange = [this.tabletLayout, this.desktopLayout];
      }

      _isFalse(a, b) {
        return !a && !b;
      }

      _fire(name, detail = null, bubbles = true, target) {
        target = target || this;
        const evt = new CustomEvent(name, { detail, bubbles });
        target.dispatchEvent(evt);
      }

    }

    customElements.define(Settings.is, Settings);
  </script>
</dom-module>