<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="/bower_components/polymer/lib/elements/dom-repeat.html">

<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="yta-lesson-card.html">

<dom-module id="yta-overview-page">
  <template>
    <style>
      
      @media (min-width: 480px) and (max-width: 960px) and (orientation: landscape), (min-width: 0px) and (max-width: 600px) and (orientation: portrait) {
        
        #placeholder {
          @apply --layout-vertical;
        }
        
      }
      
      @media (min-width: 961px) and (orientation: landscape), (min-width: 601px) and (orientation: portrait) {
        
        #placeholder {
          @apply --layout-horizontal;
          @apply --layout-wrap;
          @apply --layout-center-justified;
          padding-top: 12px !important;
        }
        
      }
      
      #placeholder {
         padding: 8px;
      }

      :host/* , #placeholder */ {
        position: relative;
        overflow: visible;
      }
    
    </style>
    
    <div id="placeholder">
      <template is="dom-repeat" items="[[lessonsToday(data.timetable)]]">
        <yta-lesson-card i="[[index]]"
                         name="[[item.name]]"
                         start-time="[[viewReadable(item.startTime)]]"
                         end-time="[[viewReadable(item.endTime)]]"
                         color="[[_pickLessonColor(item.name)]]"
                         classroom="[[item.classroom]]"
                         phone-layout="[[phoneLayout]]"
                         ></yta-lesson-card>
      </template>
      <template is="dom-if" if="[[phoneLayout]]">
        <yta-lesson-card blank phone-layout="[[phoneLayout]]"></yta-lesson-card>
      </template>
    </div>
  </template>
  
  <script>
    class OverviewPage extends Polymer.Element {
      static get is() { return 'yta-overview-page'; }
      static get properties() {
        return {
          
          // Inherited from Shell
          phoneLayout: {
            type: Boolean,
            notify: true,
            reflectToAttribute: true
          },
          
          // Inherited from MainView
          data: {
            type: Object,
            notify: true
          }
          
        };
      }
      
      constructor() {
        super();
      }
      
      connectedCallback() {
        super.connectedCallback();
        const evt = new CustomEvent('OVERIVIEW-PAGE-loaded');
        this.dispatchEvent(evt, { bubbles: true });
      }
      
      lessonsToday(tt) {
        if (tt == null) {
          this._fire('err-no-data');
          return [];
        } else {
          const now = new Date();
          const todayTt = tt[now.getUTCDay() - 1];
          if (now.getUTCDay() > tt.length || now.getUTCDay() == 0) {
            return tt[0];
          } else if (this.hoursTimer(now) >= this.hoursTimer(todayTt[todayTt.length - 1].endTime)) {
            if (now.getUTCDay() + 1 > tt.length) {
              return tt[0];
            } else {
              return tt[now.getUTCDay()];
            }
          } else {
            return todayTt;
          }
        }
      }
      
      viewReadable(time) {
        const date = new Date(time);
        let hours = date.getUTCHours(),
            minutes = date.getUTCMinutes(),
            pm = false;
        if (this.data.settings.use12hoursClock && hours > 12) {
          hours -= 12;
          pm = true;
        }
        if (minutes.toString().length === 1) minutes = '0' + minutes;
        let output = hours + ':' + minutes;
        if (this.data.settings.use12hoursClock) {
          output += pm ? ' AM' : ' PM'; 
        }
        return output;
      }
      
      hoursTimer(date) {
        const output = new Date();
        const input = new Date(date);
        output.setUTCHours(input.getUTCHours(), input.getUTCMinutes());
        return output.getTime();
      }
      
      _pickLessonColor(name) {
        const config = this.data.config;
        return config[name].color;
      }
      
      _fire(name, detail = null, bubbles = true, target) {
        target = target || this;
        const evt = new CustomEvent(name, { detail, bubbles });
        target.dispatchEvent(evt);
      }
    }
    
    customElements.define(OverviewPage.is, OverviewPage);
  </script>
</dom-module>