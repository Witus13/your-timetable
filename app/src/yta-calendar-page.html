<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/polymer/lib/elements/dom-if.html">

<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-styles/paper-styles.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-item/paper-item-body.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="/bower_components/neon-animation/animations/slide-from-bottom-animation.html">
<link rel="import" href="/bower_components/neon-animation/animations/slide-down-animation.html">

<link rel="import" href="ycons.html">
<link rel="import" href="paper-calendar.html">

<script src="/bower_components/moment/min/moment.min.js"></script>

<dom-module id="yta-calendar-page">
  <template>
    <style>

      @media (min-width: 480px) and (max-width: 960px) and (orientation: landscape), (min-width: 0px) and (max-width: 600px) and (orientation: portrait) {
        /* Phone styles */
        
        #calendar {
          position: fixed;
          top: 50px;
          bottom: 72px;
          right: 15px;
          left: 15px;
        }
      }

      @media (min-width: 961px) and (orientation: landscape), (min-width: 601px) and (orientation: portrait) {
        /* Other than phone */

        #calendar {
          height: 600px;
          max-width: 500px;
          margin: 30px auto;
        }

        #header {
          max-width: 500px;
          margin: 0 auto;
        }
      }

      #header {
        @apply --layout-flex;
        @apply --layout-horizontal;
        @apply --layout-center;
        height: 60px;
        padding: 0 16px;
      }

      #header > span {
        @apply --layout-flex;
        @apply --paper-font-menu;
        text-transform: uppercase;
        text-align: center;
        position: relative;
        left: 20px;
        opacity: var(--light-primary-opacity);
     }

     #header > paper-icon-button {
       opacity: var(--light-secondary-opacity);
     }

      #calendar {
        --paper-calendar-selected-background: var(--accent-color);
        --paper-calendar-selected-color: rgba(0,0,0,.87);
        --paper-calendar-event-background: var(--primary-color);
        --paper-calendar-table: {
          width: 100%;
        };
      }

    </style>
    
    <div id="header">
      <paper-icon-button icon="ycons:keyboard-arrow-left" on-tap="_previousMonth"></paper-icon-button>
      <span>[[_computeMonthName(_selectedMonth)]]</span>
      <paper-icon-button icon="ycons:event" on-tap="_today"></paper-icon-button>
      <paper-icon-button icon="ycons:keyboard-arrow-right" on-tap="_nextMonth"></paper-icon-button>
    </div>
    <paper-calendar id="calendar" selectable on-selected="_calendarSelected"
                    swipeable swipe-direction="vertical"
                    events="[[_processEvents(data.events)]]"
                    first-day="[[data.settings.firstDayOfWeek]]"
                    selected-month="{{_selectedMonth}}"></paper-calendar>

    <paper-dialog id="dialog" entry-animation="slide-from-bottom-animation" with-backdrop
                  exit-animation="slide-down-animation" style="border-radius:2px;">
      <h2></h2>
      <paper-dialog-scrollable>
        <template is="dom-repeat">
          <paper-item class="event" style="background-color: [[item.color]];">
            <paper-item-body two-line>
              <template is="dom-if" if="true">
                <div class="primary">
                  <span class="header">[[item.name]]</span>
                  <div class="actions" info$="[[item.date]][[index]]">
                    <paper-icon-button icon="ycons:edit" class="edit-button"></paper-icon-button>
                    <paper-icon-button icon="ycons:delete" class="delete-button"></paper-icon-button>
                  </div>
                </div>
                <div secondary>[[_getLessonName(item.date, item.lesson)]]</div>
              </template>
              <template is="dom-if">
                <paper-input no-label-float value="[[item.name]]"></paper-input>
                <paper-icon-button  info$="[[item.date]][[index]]" icon="ycons:done" on-tap="_finishedEditing"></paper-icon-button>
                <div secondary>
                  <paper-input type="date" no-label-float value="[[item.date]]" on-value-changed="_showLessons"></paper-input>
                  <paper-dropdown-menu>
                    <paper-listbox selected="[[item.lesson]]">
                      <template is="dom-repeat">
                        <paper-item>[[item]]</paper-item>
                      </template>
                    </paper-listbox>
                  </paper-dropdown-menu>
                </div>
              </template>
            </paper-item-body>
          </paper-item>
        </template>
      </paper-dialog-scrollable>
    </paper-dialog>
  </template>
  
  <script>
    class CalendarPage extends Polymer.Element {
      static get is() { return 'yta-calendar-page'; }
      static get properties() {
        return {
          
          // Inherited from MainView
          data: {
            type: Object,
            notify: true
          },

          _selectedMonth: Number
          
        };
      }
      
      constructor() {
        super();
      }
      
      connectedCallback() {
        super.connectedCallback();
      }

      _calendarSelected(e) {
        const date = e.detail.date,
              events = this.data.events;
        if (!events) return;
        this._checkForEventsOn(date, events).then(dayEvents => {
          // Create styles
          const styles = `
            #dialog .event {
              width: 240px;
              color: white;
              margin: 2px;
              border-radius: 2px;
              background-color: var(--primary-color);
            }

            #dialog .event .primary {
              display: flex;
              flex-direction: row;
            }

            #dialog .event .primary .header {
              flex: 1;
            }

            #dialog .event [secondary] {
              color: white;
              opacity: var(--light-secondary-opacity);
            }

            #dialog .event paper-icon-button {
              opacity: var(--light-secondary-opacity);
              padding: 0 4px;
              height: 22px;
              width: 30px;
            }

            #dialog paper-input {
              --paper-input-container-color: white;
              --paper-input-container-focus-color: white;
              --paper-input-container-input-color: white;
            }
          `
          // Add content
          this.shadowRoot.querySelector('#dialog > h2').textContent = moment(date).format('MMMM Do YYYY');
          // Refresh events items to remove previous states
          const domRepeat = this.shadowRoot.querySelector('#dialog dom-repeat');
          domRepeat.items = [];
          domRepeat.render();
          domRepeat.items = dayEvents;
          domRepeat.render();
          // Asign callbacks
          this.shadowRoot.querySelectorAll('#dialog .edit-button').forEach(item => item.addEventListener('click', this._editEvent.bind(this)));
          this.shadowRoot.querySelectorAll('#dialog .delete-button').forEach(item => item.addEventListener('click', this._deleteEvent.bind(this)));
          // Open dialog
          this._openDialog(this.$.dialog, styles);
        }, err => { if (err !== 'noevents') throw err })
      }

      _checkForEventsOn(date, events) {
        return new Promise((resolve, reject) => {
          const regexp = new RegExp(`^${date}.+`, 'g'),
                output = [];
          Object.keys(events).forEach(key => {
            if (key.match(regexp)) output.push(events[key]);
          });
          if (!output.length) {
            reject('noevents');
          } else {
            output.sort((a, b) => a.lesson - b.lesson);
            resolve(output);
          }
        });
      }

      _editEvent(e) {
        const domIfs = e.target.parentElement.parentElement.parentElement.querySelectorAll('dom-if');
        domIfs[0].if = false;
        domIfs[1].if = true;
      }

      _finishedEditing(e) {
        //..
      }

      _showLessons(e) {
        const lessons = [];
        this.data.timetable[moment(e.detail.value).day()].forEach((item, index) => {
          lessons.push(index + 1 + '. ' + item.name);
        });
        e.target.nextSibling.querySelector('dom-repeat').items = lessons;
      }

      _deleteEvent(e) {
        const events = this.data.events,
              info = e.target.parentElement.getAttribute('info'),
              date = info.slice(0, 10),
              index = Number(info.slice(-1, -0)),
              regexp = new RegExp(`^${date}.+`, 'g'),
              filtered = [],
              untouched = [],
              filteredObj = {},
              untouchedObj = {},
              giveName = (event, index) => {
                return event.date + '_' + index;
              };
        Object.keys(events).forEach(key => {
          key.match(regexp) ? filtered.push(events[key]) : untouched.push(events[key]);
        });
        filtered.splice(index, 1);
        filtered.forEach((item, index) => {
          Object.assign(filteredObj, { [giveName(item, index)]: item })
        });
        untouched.forEach((item, index) => {
          Object.assign(untouchedObj, { [giveName(item, index)]: item })
        });
        this.data.events = Object.assign(untouchedObj, filteredObj);
        this.notifyPath('data.events');
        e.target.parentElement.parentElement.parentElement.parentElement.remove();
      }

      _getLessonName(date, index) {
        let day = moment(date).day();
        if (this.data.timetable[day]) {
          return index + '. ' + this.data.timetable[day][index].name;
        } else {
          return '';
        }
      }

      _openDialog(dialog, style = null) {
        // Create nescessary styles
        let styleEl;
        if (style) {
          styleEl = document.createElement('style');
          styleEl.innerHTML = style;
          document.head.appendChild(styleEl);
        }
        // Remember current parent to...
        const parent = dialog.parentNode;
        // ...move it back when it closes
        dialog.addEventListener('iron-overlay-closed', () => {
          if (styleEl) styleEl.remove();
          parent.appendChild(dialog);
        }, { once: true });
        // Move element
        document.body.appendChild(dialog);
        dialog.open();
      }

      _processEvents(events) {
        if (!events || Object.keys(events).length === 0) return;
        const output = [];
        Object.keys(events).forEach(key => output.push(events[key]));
        return output;
      }
      
      _computeMonthName(month) {
        return moment(month).format('MMMM');
      }

      _nextMonth() {
        this._selectedMonth = Number(moment(this._selectedMonth).add(1, 'months').format('x'));
      }

      _previousMonth() {
        this._selectedMonth = Number(moment(this._selectedMonth).subtract(1, 'months').format('x'));
      }

      _today() {
        this._selectedMonth = Number(moment().format('x'));
      }
    }
    
    customElements.define(CalendarPage.is, CalendarPage);
  </script>