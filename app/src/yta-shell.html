<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/app-route/app-location.html">
<link rel="import" href="/bower_components/app-route/app-route.html">

<link rel="import" href="/bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="/bower_components/iron-resizable-behavior/iron-resizable-behavior.html">

<link rel="import" href="/bower_components/neon-animation/neon-animations.html"><!-- Pick only nescessary ones -->
<link rel="import" href="/bower_components/neon-animation/neon-animated-pages.html">

<link rel="import" href="yta-main-view.html">

<dom-module id="yta-shell">
  <template>
    <style>
      
      :host {
        /* --paper-font-common-base */
        font-family: 'Roboto', 'Noto', sans-serif;
        -webkit-font-smoothing: antialiased;
        /* Turn off selection */
        -moz-user-select: none;
        -ms-user-select: none;
        -webkit-user-select: none;
        user-select: none;
      }
      
      neon-animated-pages, neon-animated-pages > * {
        /* --layout-fit */
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
      
    </style>
    
    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}"
               pattern="/:page"
               data="{{routeData}}"
               id="router"></app-route>
    
    <iron-media-query query="(min-width: 480px) and (max-width: 960px) and (orientation: landscape), (min-width: 0px) and (max-width: 600px) and (orientation: portrait)"
                      query-matches="{{phoneLayout}}"></iron-media-query>
    
    <neon-animated-pages selected="[[selected]]" attr-for-selected="key">
      <yta-main-view key="main"
                     phone-layout="[[phoneLayout]]"
                     data="{{appData}}"
                     style="display:block!important"></yta-main-view>
      <yta-settings key="settings"></yta-settings>
      <yta-onboarding key="onboarding" phone-layout="[[phoneLayout]]" desktop-layout="[[desktopLayout]]"></yta-onboarding>
      <yta-setup-dialog key="setup" phone-layout="[[phoneLayout]]"></yta-setup-dialog>
      <yta-add-dialog key="add"
                      app-data="{{appData}}"
                      phone-layout="[[phoneLayout]]"></yta-add-dialog>
      <yta-feedback-dialog key="feedback"></yta-feedback-dialog>
    </neon-animated-pages>
  </template>
  
  <script>
    Polymer({
      is: 'yta-shell',
      
      behaviors: [
        Polymer.IronResizableBehavior,
      ],
      
      properties: {
        
        selected: {
          type: String,
          notify: true,
          value: 'main'
        },
        
        appData: {
          type: Object,
          notify: true
        },
        
        // Layout indicators
        
        phoneLayout: {
          type: Boolean,
          notify: true
        },
        
        /* @note
        This layout is not going to be used until later release
        */
        tabletLayout: {
          type: Boolean,
          notify: true,
          value: false // To be removed - only for testing
        },
        
        desktopLayout: {
          type: Boolean,
          notify: true,
          computed: 'isFalse(phoneLayout, tabletLayout)'
        }
        
      },
      
      listeners: {
        'switch-page': 'switchRoute'
      },
      
      observers: [
        'resolveRoute(routeData.page)'
      ],
      
      /*attached: function() {
        console.log('yta-shell attached() fired');
        shell = this;
        if(!this.route.path || this.route.path == '/') {
          this.set('route.path', '/app')
        };
        if(!'serviceWorker' in navigator) {
          this.importHref('src/yta-add-dialog.html', null, null, true)
        }
      },*/
      
      ready: function() {
        console.log('yta-shell ready() fired');
        shell = this;
        if(!this.route.path || this.route.path == '/') {
          this.set('route.path', '/app')
        };
        if(!'serviceWorker' in navigator) {
          this.importHref('src/yta-add-dialog.html', null, null, true)
        }
      },
      
      switchRoute: function(e) {
        switch (e.detail.action) {
          case 'openAddDialog':
             this.importHref('src/yta-add-dialog.html', function() {
              addDialog.open();
              this.selected = 'add';
              this.set('routeData.page', 'add');
            }, null, true);
            break;
          case 'closeAddDialog':
            addDialog.$.dialog.close();
            this.selected = 'main';
            this.set('routeData.page', 'app');
            break;
          case 'openOnboarding':
            this.importHref('src/yta-onboarding.html', function() {
              onboarding.open()
              this.selected = 'onboarding';
              this.set('routeData.page', 'welcome');
            }, null, true);
            break;
          case 'closeOnboarding':
            onboarding.close();
            this.selected = 'main';
            this.set('routeData.page', 'app');
            break;
          case 'openSetupDialog':
            this.importHref('src/yta-setup-dialog.html', function() {
              this.selected = "setup";
              this.set('routeData.page', 'app');
            });
            break;
          default:
            throw('`switch-page` event fired without or with unknown action!')
        }
      },
      
      resolveRoute: function(toPage) {
        if(toPage == 'app') {
          if(addDialog && addDialog.isActive) {
            this.set('routeData.page', 'add');
            addDialog.$.dialog.fire('iron-overlay-canceled', 'page redirect', { cancelable: true });
          } else if(onboarding && onboarding.isActive) {
            this.set('routeData.page', 'welcome');
          }
        };
      },
      
      checkForTargets: function() {
        return new Promise((resolve, reject) => {
          const output = this.$.router.queryParams.target;
          if(output) {
            const validTargets = ['main', 'timetable', 'teachers', 'calendar']
            if(validTargets.include(output)) {
              resolve(output)
            } else {
              reject('invalid target')
            }
          } else {
            reject('no targets')
          }
        })
      },
      
      isFalse: function(arg1, arg2) {
        if(!arg1 && !arg2) {
          return true
        } else {
          return false
        }
      }
    })
  </script>
</dom-module>