<link rel="import" href="/bower_components/polymer/polymer-element.html">

<link rel="import" href="/bower_components/app-route/app-location.html">
<link rel="import" href="/bower_components/app-route/app-route.html">

<link rel="import" href="/bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="/bower_components/iron-pages/iron-pages.html">

<link rel="import" href="yta-main-view.html">

<link rel="preload" href="yta-add-dialog.html">

<dom-module id="yta-shell">
  <template>
    <style>
      
      :host > * {
        /* Turn off selection */
        -moz-user-select: none;
        -ms-user-select: none;
        -webkit-user-select: none;
        user-select: none;
      }
      
      neon-animated-pages, neon-animated-pages > * {
        /* --layout-fit */
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
      
    </style>
    
    <!-- Router -->
    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}"
               pattern="/:page"
               data="{{routeData}}"
               id="router"></app-route>
    
    <!-- Set layout indicators -->
    <iron-media-query query="(min-width: 480px) and (max-width: 960px) and (orientation: landscape), (min-width: 0px) and (max-width: 600px) and (orientation: portrait)"
                      query-matches="{{phoneLayout}}"></iron-media-query>
    <iron-media-query query="(min-width: 601px) and (max-width: 840px) and (orientation: portrait), (min-width: 961px) and (max-width: 1279px) and (orientation: landscape)"
                      query-matches="{{tabletLayout}}"></iron-media-query>
    
    <!-- Switch between views -->
    <iron-pages selected="[[selected]]" attr-for-selected="key">
      <yta-main-view key="main"
                     phone-layout="[[phoneLayout]]"
                     data="{{appData}}"
                     style="display:block!important"></yta-main-view>
                     <!-- ^^^ this is used to keep the main view visible -->
                     
      <yta-settings key="settings"></yta-settings>
      
      <yta-onboarding key="onboarding" desktop-layout="[[desktopLayout]]" tablet-layout="[[tabletLayout]]"></yta-onboarding>
                      
      <yta-setup-dialog key="setup" desktop-layout="[[desktopLayout]]" tablet-layout="[[tabletLayout]]" app-data="{{appData}}"></yta-setup-dialog>
      
      <yta-add-dialog key="add"
                      app-data="{{appData}}"
                      phone-layout="[[phoneLayout]]"></yta-add-dialog>
                      
      <yta-feedback-dialog key="feedback"></yta-feedback-dialog>
      
      <yta-about-page key="about"></yta-about-page>
    </iron-pages>
  </template>
  
  <script>
    class Shell extends Polymer.Element {
      static get is() { return 'yta-shell'; }
      static get config() {
        return {
          properties: {
          
            // Currently selected view
            selected: {
              type: String,
              notify: true,
              value: 'main'
            },
            
            // Sharing the user data between views
            appData: {
              type: Object,
              notify: true
            },
            
            // Layout indicators
            phoneLayout: {
              type: Boolean,
              notify: true
            },
            
            tabletLayout: {
              type: Boolean,
              notify: true
            },
            
            desktopLayout: {
              type: Boolean,
              notify: true,
              computed: '_isFalse(phoneLayout, tabletLayout)'
            }
            
          },
          
          observers: [
            '_resolveRoute(routeData.page)'
          ],
        };
      }
      
      constructor() {
        super();
      }
      
      ready() {
        super.ready();
        
        // Add event listeners
        this.addEventListener('switch-page', this._switchRoute);
      }
      
      connectedCallback() {
        super.connectedCallback();
        
        // Set route if null
        if (!this.route.path || this.route.path == '/') {
          this.set('route.path', '/app');
        }
      }
      
      checkForTargets() {
        return new Promise((resolve, reject) => {
          const output = this.$.router.queryParams.target;
          if (output) {
            const validTargets = ['main', 'timetable', 'teachers', 'calendar'];
            if (validTargets.include(output)) {
              resolve(output);
            } else {
              reject('invalid-target');
            }
          } else {
            reject('no-targets');
          }
        });
      }
      
      _switchRoute(e) {
        switch (e.detail.action) {                                              // @TODO (@Witus): All child elements must implement event listening for parent open/close-name events
          case 'openAddDialog':
            importHref('src/yta-add-dialog.html').then(() => {
              const withAnimation = this.selected === 'main' ? true
                                                             : false;
              const clientRect = this.desktopLayout ? null :
                                                      e.detail.clientRect;
              this._fire('open-add-dialog', { clientRect, withAnimation });
              this.selected = 'add';
              this.routeData.page = 'add';
              this.routeData = this.routeData;
            });
            break;
          case 'closeAddDialog':
            const clientRect = this.desktopLayout ? null :
                                                    e.detail.clientRect;
            this._fire('close-add-dialog', { clientRect: clientRect });
            this.selected = 'main';
            this.routeData.page = 'app';
            this.routeData = this.routeData;
            break;
          case 'openOnboarding':
            importHref('src/yta-onboarding.html').then(() => {
              this._fire('open-onboarding');
              this.selected = 'onboarding';
              this.routeData.page = 'welcome';
              this.routeData = this.routeData;
            });
            break;
          case 'closeOnboarding':
            this._fire('close-onboarding');
            this.selected = 'main';
            this.routeData.page = 'app';
            this.routeData = this.routeData;
            break;
          case 'openSetupDialog':
            importHref('src/yta-setup-dialog.html').then(() => {
              this._fire('open-setup-dialog');
              this.selected = 'setup';
              this.routeData.page = 'app';
              this.routeData = this.routeData;
            });
            break;
          default:
            console.error('`switch-page` event fired without or with unknown action!', e);
        }
      }
      
      _resolveRoute(toPage) {
        /* EXTREAMLY BUGGY
        if (toPage == 'app') {
          if (addDialog && addDialog.isActive) {
            this.set('routeData.page', 'add');
            addDialog.$.dialog.fire('iron-overlay-canceled', 'page redirect', { cancelable: true });
          } else if (onboarding && onboarding.isActive) {
            this.set('routeData.page', 'welcome');
          }
        };*/
      }
      
      _fire(name, detail = null, bubbles = true, target) {
        target = target || this;
        const evt = new CustomEvent(name, { detail, bubbles });
        target.dispatchEvent(evt);
      }
        
      _isFalse(arg1, arg2) {
        return !arg1 && !arg2;
      }
    }
    
    customElements.define(Shell.is, Shell);
  </script>
</dom-module>