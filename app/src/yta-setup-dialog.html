<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/polymer/lib/elements/dom-repeat.html">

<link rel="import" href="/bower_components/iron-selector/iron-selector.html">

<link rel="import" href="/bower_components/paper-styles/paper-styles.html"> <!-- Replace with smaller package -->
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="/bower_components/vaadin-combo-box/vaadin-combo-box.html">

<script defer src="/bower_components/moment/moment.js"></script>

<link rel="import" href="ycons.html">
<link rel="import" href="app-localize-behavior-mixin.html">
<link rel="import" href="yta-theme.html">

<dom-module id="yta-setup-dialog">
  <template>
    <style>
      
      @media (max-width: 960px) and (orientation: landscape),
             (min-width: 0px) and (max-width: 600px) and (orientation: portrait) {
        /* Phone styles */
        
        #main {
          @apply --layout-fit;
        }
        
        .lesson-inputs .grid {
          width: 100%;
        }
      }
      
      @media (min-width: 961px) and (max-width: 1279px) and (orientation: landscape),
             (min-width: 601px) and (max-width: 840px) and (orientation: portrait) {
        /* Tablet styles */
        
        #main {
          @apply --layout-fit;
        }
        
        .lesson-inputs .grid {
          width: 49%;
        }
      }
      
      @media (min-width: 841px) and (orientation: portrait), (min-width: 1280px) and (orientation: landscape) {
        /* Desktop styles */
        
        :host {
          @apply --layout;
          @apply --layout-center;
          @apply --layout-center-justified;
        }
        
        #main {
          width: 750px;
          height: 750px;
          position: relative;
        }
        
        /* Hide ugly scrollbar in Chrome on desktop */
        #main::-webkit-scrollbar { width: 0 !important; }
        
        #main {
          @apply --shadow-elevation-16dp;
        }
        
        #main, .page {
          border-radius: 25px;
        }
        
        .lesson-inputs .grid {
          width: 49%;
        }
        
        .next {
          bottom: -15px !important;
          border-radius: 0 0 25px 25px;
        }
        
      }
      
      :host {
        transform: translateY(100vh);
        background: rgba(0, 0, 0, 0.3);
        z-index: 999;
        @apply --paper-font-common-base;
      }
      
      :host(.open) {
        transform: none;
      }
      
      :host, iron-swipeable-pages {
        @apply --layout-fit;
      }
      
      #main {
        background-color: white;
        padding: 15px;
        overflow-y: scroll;
      }
      
      #weekDays {
        display: inline-block;
      }
      
      #weekDays .selectable-item {
        display: inline-block;
        width: 40px;
        height: 40px;
        line-height: 40px;
        border-radius: 50%;
        background-color: var(--paper-grey-200);
        color: black;
        opacity: var(--dark-primary-opacity);
        transition: background-color 150ms;
        padding: 0;
        margin: 3px;
        vertical-align: middle;
        text-align: center;
      }
      
      #weekDays .selectable-item:focus {
        background-color: var(--paper-grey-400);
        outline: none;
      }
      
      #weekDays .selectable-item.iron-selected:focus {
        background-color: var(--dark-primary-color);
      }
      
      #weekDays .selectable-item.iron-selected {
        color: white;
        opacity: 1;
        background-color: var(--primary-color);
      }
      
      h2 {
        @apply --paper-font-display1;
      }
      
      h3 {
        @apply --paper-font-headline;
        margin-top: 17px !important;
      }
      
      .lesson-inputs {
        position: relative;
        left: -15px;
        width: calc(100% + 40px);
        padding: 13px;
      }
      
      .lesson {
        display: inline-block;
        position: relative;
        width: 100%;
        border-bottom: 1px var(--light-theme-divider-color) solid;
        @apply --layout-horizontal;
      }
      
      .lesson > .remove-lesson {
        position: relative;
        top: 4px;
        opacity: 0.54;
      }
      
      .add-lesson {
        margin-top: 2px;
      }
      
      .lesson > .lesson-inputs {
        @apply --layout-flex;
      }
      
      .day {
        position: relative;
        left: -15px;
        width: 100%;
        padding: 15px;
        @apply --shadow-transition;
      }
      
      .day:hover {
        @apply --shadow-elevation-4dp;
      }
      
      .next {
        position: sticky;
        bottom: 0;
        padding: 6px;
        margin: 0px -15px;
        border-top: 1px var(--light-theme-divider-color) solid;
        background-color: white;
        @apply --layout-horizontal;
        @apply --layout-center;
      }
      
      .next > .add-lesson {
        opacity: var(--dark-secondary-opacity);
      }

      .next > .spacer {
        @apply --layout-flex;
      }
      
      .next > paper-button {
        color: var(--primary-color);
        font-weight: 500;
      }
      
      hr {
        border: 0;
        border-bottom: 1px var(--light-theme-divider-color) solid;
        position: relative;
        left: -15px;
        width: calc(100% + 30px);
        margin: 12px 0;
      }
      
      .label-text {
        opacity: var(--dark-primary-opacity);
        font-size: 16px;
        margin: 0 2px;
      }
      
      .lesson-name-input, .class-input, .teacher-input, .time-input {
        margin: 0 2px;
        display: inline-block;
      }
      
      #spinner {
        @apply --layout-vertical;
        @apply --layout-center;
        @apply --layout-center-justified;
        @apply --layout-fit;
        background: white;
      }
      
      #spinner.animate {
        transition: all 250ms ease-out;
      }
      
      #spinner.hidden {
        opacity: 0;
      }
      
      #spinner.right {
        transform: translateX(100%);
      }
      
      #spinner p {
        @apply --paper-font-body;
        opacity: var(--dark-secondary-opacity);
        margin: 15px;
      }
      
      #spinner paper-spinner-lite {
        --paper-spinner-color: var(--primary-color);
      }
      
      section .margin {
        margin: 10px 6px;
      }
      
      section .margin-sides {
        margin: 0 6px;
      }
      
      #init paper-toggle-button {
        margin: 0 0 16px 4px;
        --paper-toggle-button-label-color: var(--light-theme-secondary-color);
      }
      
      .lesson-input {
        @apply --layout-vertical;
        @apply --layout-wrap;
      }
      
      .lesson-inputs .grid {
        @apply --layout-inline;
        @apply --layout-horizontal;
        @apply --layout-center;
        display: inline-flex;
      }
      
    </style>
    
    <div id="main">
      <section id="init">
        <h2 class="margin">[[localize('setup_header')]]</h2>
        <h3 class="margin">[[localize('setup_daysToSchool')]]</h3>
        <iron-selector multi id="weekDays" selected-values="{{weekDays}}" class="margin" attr-for-selected="i">
          <div tabindex="0" i=0 class="selectable-item">[[localize('weekDaysShort', 'd', '0')]]</div>
          <div tabindex="0" i=1 class="selectable-item">[[localize('weekDaysShort', 'd', '1')]]</div>
          <div tabindex="0" i=2 class="selectable-item">[[localize('weekDaysShort', 'd', '2')]]</div>
          <div tabindex="0" i=3 class="selectable-item">[[localize('weekDaysShort', 'd', '3')]]</div>
          <div tabindex="0" i=4 class="selectable-item">[[localize('weekDaysShort', 'd', '4')]]</div>
          <div tabindex="0" i=5 class="selectable-item">[[localize('weekDaysShort', 'd', '5')]]</div>
          <div tabindex="0" i=6 class="selectable-item">[[localize('weekDaysShort', 'd', '6')]]</div>
        </iron-selector>
        <hr noshadow>
        <h3 class="margin">
          [[localize('setup_pref')]]<br>
        </h3>
        <paper-dropdown-menu label="[[localize('set_firstDayOfWeek')]]" id="firstDayOfWeek" class="margin" on-value-changed="_changeFirstDayOfWeek">
          <paper-listbox slot="dropdown-content" class="dropdown-content" attr-for-selected="i">
            <paper-item i="1">[[localize('weekDays', 'd', '1')]]</paper-item>
            <paper-item i="6">[[localize('weekDays', 'd', '6')]]</paper-item>
            <paper-item i="0">[[localize('weekDays', 'd', '0')]]</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
        <paper-toggle-button class="margin" id="clock12">[[localize('set_12h')]]</paper-toggle-button>
        <div class="next">
          <span class="spacer"></span>
          <paper-button on-tap="_afterInit">[[localize('setup_next')]]</paper-button>
        </div>
      </section>
      <section id="daySection" style="display:none;">
        <h3 class="margin"></h3>
        <template is="dom-repeat" class="lesson-placeholder" initial-count="2" as="lesson" index-as="lessonIndex">
          <div class="lesson" l$="[[lessonIndex]]">
            <div class="lesson-inputs">
              <vaadin-combo-box class="lesson-name-input grid" label="[[localize('setup_yourLesson')]]"
                                no-label-float allow-custom-value item-value-path="name"
                                on-custom-value-set="_processCustomLessonInputValue"
                                on-change="_lessonSet" items="[[_lessonsInfo]]"
                                item-label-path="name"></vaadin-combo-box>
              <div class="grid">
                <span class="label-text">[[localize('setup_in')]]</span>
                <paper-input class="class-input" label="[[localize('setup-class')]]" no-label-float on-change="_computeNewInputClass"></paper-input>
              </div>
              <div class="grid">
                <span class="label-text">[[localize('setup_with')]]</span>
                <paper-input class="teacher-input" label="[[localize('setup_teacher')]]" no-label-float on-change="_computeNewInputTeacher"></paper-input>
              </div>
              <div class="grid">
                <span class="label-text">[[localize('setup_starts')]]</span>
                <paper-input type="time" class="time-input start-time-input" no-label-float on-change="_computeNewInputTime"></paper-input>
                <span class="label-text">[[localize('setup_ends')]]</span>
                <paper-input type="time" class="time-input end-time-input" no-label-float on-change="_computeNewInputTime"></paper-input>
              </div>
            </div>
            <paper-icon-button icon="ycons:remove-circle" on-tap="_removeLesson"
                               tabindex="-1" class="remove-lesson"></paper-icon-button>
          </div>
        </template>
        <div class="next">
          <paper-icon-button class="add-lesson" on-tap="_addLesson"
                            icon="ycons:add"></paper-icon-button>
          <span class="spacer"></span>
          <paper-button on-tap="_proceed">[[localize('setup_next')]]</paper-button>
        </div>
      </section>
      <div id="spinner" class="right">
        <paper-spinner-lite></paper-spinner-lite>
      </div>
    </div>
  </template>
  
  <script>
    class SetupDialog extends Polymer.AppLocalizeBehaviorMixin(Polymer.Element) {
      static get is() { return 'yta-setup-dialog'; }
      static get properties() {
        return {
          
          // Inherited from shell
          desktopLayout: {
            type: Boolean
          },
          
          // Inherited from shell
          tabletLayout: {
            type: Boolean
          },
          
          // Days in which user goes to school
          weekDays: {
            type: Array,
            value: () => []
          },
          
          // User data
          appData: {
            type: Object,
            notify: true
          },
          
          // Arrays of lessons in certain days contained in array
          _lessonsOnDays: {
            type: Array,
            value: () => []
          },
          
          // Lesson names and their info that was used in any field
          _lessonsInfo: {
            type: Array,
            value: () => []
          }
        };
      }
      
      constructor() {
        super();
      }
      
      ready() {
        super.ready();
        
        // Init variables with defaults
        this.weekDays = ['1','2','3','4','5'];
        this._lessonTime = 2700000;
        this._breakTime = 600000;
      }
      
      connectedCallback() {
        super.connectedCallback();
        
        // Complicated? parentElement is neon-animated-pages, parentNode is ShadowRoot and we need it's host
        //              But if it's not Shadow DOM, pick just parentElement
        if (!this._shell) this._shell = Polymer.Settings.useShadow ? this.parentElement.parentNode.host
                                                                   : this.parentElement.parentElement;
        
        // Add event listeners
        this._shell.addEventListener('open-setup-dialog', () => this.open());
        this._shell.addEventListener('close-setup-dialog', () => this.close());
        
        // Init worker
        this._worker = new Worker('/src/setup-dialog-worker.js');
        
        // Async check l10n
        setTimeout(async () => {
          // Start loading locale ahaed of time
          if (navigator.language !== 'en-US') var localeDownload = this._loadLocale(navigator.language);
          // Reference menu elements
          const firstDayOfWeekEl = this.shadowRoot.querySelector('#firstDayOfWeek > paper-listbox'),
                clock12El = this.$.clock12;
          // Make sure correct locale is loaded
          if (navigator.language !== 'en-US') {
            await localeDownload;
          }
          // Read l10n
          firstDayOfWeekEl.selected = moment.localeData().firstDayOfWeek();
          clock12El.checked = new Date().toLocaleString().slice(-1) === 'M';
        }, 0);
      }
      
      disconnectedCallback() {
        if (!this._shell) return;
        
        // Remove event listeners
        this._shell.removeEventListener('open-setup-dialog', () => this.open());
        this._shell.removeEventListener('close-setup-dialog', () => this.close());
        
        // Kill worker
        this._worker.terminate();
      }
      
      open() {
        this.style.transition = 'transform 200ms ease-out';
        this._computeTransitionTimes();
        Polymer.RenderStatus.afterNextRender(this, () => { 
          this.classList.add('open');
        });
      }
      
      close() {
        this.style.transition = 'transform 200ms ease-in';
        this._computeTransitionTimes();
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            this.classList.remove('open');
          });
        });
        waitMs(300).then(() => this.remove());
      }
      
      _afterInit() {
        const firstDayOfWeek = this.shadowRoot.querySelector('#firstDayOfWeek > paper-listbox').selected;
        if (!firstDayOfWeek) {
          this.$.firstDayOfWeek.invalid = true;
          return;
        }
        this.appData.settings = {
          use12hoursClock: this.$.clock12.checked,
          firstDayOfWeek
        };
        this._openWaiter();
        this.$.init.style.display = 'none';
        this.$.daySection.style.display = 'block';
        this.weekDays.sort((a,b) => {
          switch (Number(firstDayOfWeek)) {
            case 1:
              a = a == 0 ? 6 : Number(a) - 1;
              b = b == 0 ? 6 : Number(b) - 1;
              return a - b;
            case 0:
              return Number(a) - Number(b);
            case 6:
              a = a == 6 ? 0 : Number(a) + 1;
              b = b == 6 ? 0 : Number(b) + 1;
              return a - b;
          }
        });
        this._currentEditedDay = Number(this.weekDays.shift());
        const dayReadable = moment().day(this._currentEditedDay).format('dddd');
        this.$.daySection.children[0].textContent = `${this.localize('setup_enterLessonsOn')} ${dayReadable}`;;
        this.$.daySection.children[1].items = this._lessonsOn(this._currentEditedDay);
        this._closeWaiter();
      }
      
      _openWaiter() {
        const waiter = this.$.spinner,
              spinner = waiter.children[0];
        spinner.active = true;
        waiter.setAttribute('class', 'right');
        waiter.setAttribute('style', '');
        waiter.classList.add('animate');
        requestAnimationFrame(() => requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            waiter.classList.remove('right');
          });
        }));
      }
      
      _closeWaiter() {
        const waiter = this.$.spinner,
              spinner = waiter.children[0];
        spinner.active = false;
        waiter.setAttribute('class', 'animate hidden');
        setTimeout(() => {
          requestAnimationFrame(() => {
            requestAnimationFrame(() => {
              waiter.style.display = 'none';
            });
          });
        }, 250);
      }
      
      _lessonsOn(day) {
        const emptyDay = [{},{},{},{},{},{},{},{}];
        if (this._lessonsOnDays.length === 0) this._lessonsOnDays = [emptyDay,emptyDay,emptyDay,emptyDay,emptyDay,emptyDay,emptyDay];
        if (this._lessonsOnDays[day].length === 0) this._lessonsOnDays[day] = [{},{},{},{},{},{},{},{}];
        return this._lessonsOnDays[day];
      }
      
      _computeTransitionTimes() {
        if (this._lastTransTimeChange &&
            this._lastTransTimeChange[0] === this.tabletLayout &&
            this._lastTransTimeChange[1] === this.desktopLayout)
        {
          return;
        }
        if (this.tabletLayout) {
          this.style.transitionDuration = '260ms';
        } else if (this.desktopLayout) {
          this.style.transitionDuration = '150ms';
        } else {
          this.style.transitionDuration = '200ms';
        }
        this._lastTransTimeChange = [this.tabletLayout, this.desktopLayout];
      }
      
      _addLesson(e) {
        const day = this._currentEditedDay;
        this._lessonsOnDays[day].push({});
        this.notifySplices('_lessonsOnDays');
        this._refreshDayPlaceholder(day);
      }
      
      _removeLesson(e) {
        const day = this._currentEditedDay;
        const lesson = e.target.parentElement.l;
        this._lessonsOnDays[day].splice(lesson, 1);
        this.notifySplices('_lessonsOnDays');
        this._refreshDayPlaceholder(day);
      }
      
      _refreshDayPlaceholder(day) {
        this.shadowRoot.querySelector('.lesson-placeholder').render();
      }
      
      _processCustomLessonInputValue(e) {
        if (!e.detail || e.detail == {}) return;
        const val = e.detail;
        const capVal = val.charAt(0).toUpperCase() + val.slice(1);
        e.preventDefault();
        this.push('_lessonsInfo', { name: capVal });
        e.target.value = capVal;
      }
      
      _changeFirstDayOfWeek(e) {
        const weekDays = this.shadowRoot.querySelector('#weekDays'),
              sat = this.shadowRoot.querySelector('#weekDays [i="6"]'),
              sun = this.shadowRoot.querySelector('#weekDays [i="0"]');
        switch (e.detail.value) {
          case "Saturday":
            weekDays.insertBefore(sun, weekDays.firstChild);
            weekDays.insertBefore(sat, weekDays.firstChild);
            break;
          case "Sunday":
            weekDays.appendChild(sat);
            weekDays.insertBefore(sun, weekDays.firstChild);
            break;
          case "Monday":
            weekDays.appendChild(sat);
            weekDays.appendChild(sun);
            break;
        }
        this.$.firstDayOfWeek.invalid = false;
      }
      
      _lessonSet(e) {
        const lessonIndex = e.target.parentElement.parentElement.getAttribute('l'),
              val = e.target.value;
        if (!val) return;
        this._askWorker([val, this._lessonsInfo]).then(result => {
          if (result.data.class) {
            this.shadowRoot.querySelector(`[l="${lessonIndex}"] .class-input`).value = result.data.class;
          }
          if (result.data.teacher) {
            this.shadowRoot.querySelector(`[l="${lessonIndex}"] .teacher-input`).value = result.data.teacher;
          }
        });
        if (lessonIndex == 0) return;
        const lastLessonEnds = this.shadowRoot.querySelector(`[l="${lessonIndex - 1}"] .end-time-input`).value;
        if (!lastLessonEnds) return;
        this._askWorker([this._lessonTime, this._breakTime, lastLessonEnds], 'calculateTime').then(result => {
          this.shadowRoot.querySelector(`[l="${lessonIndex}"] .start-time-input`).value = result.data[0];
          this.shadowRoot.querySelector(`[l="${lessonIndex}"] .end-time-input`).value = result.data[1];
        });
      }

      _proceed() {
        this._openWaiter();
        const day = this._currentEditedDay,
              output = [],
              config = this.appData.config || {},
              inputs = this.shadowRoot.querySelectorAll('.lesson'),
              colorsPalette =
                [
                  '#f44336', '#E91E63', '#9c27b0', '#3f51b5', '#2196F3',
                  '#009688', '#ff9800', '#ff5722', '#795548', '#4caf50'
                ];
        let availableColors = colorsPalette;
        inputs.forEach((lesson, index) => {
          const lessonIndex = lesson.getAttribute('l'),
                lessonName = this.shadowRoot.querySelector(`[l="${lessonIndex}"] .lesson-name-input`).value;
          if (!lessonName) return;
          const startTimeVal = this.shadowRoot.querySelector(`[l="${lessonIndex}"] .start-time-input`).value,
                endTimeVal = this.shadowRoot.querySelector(`[l="${lessonIndex}"] .end-time-input`).value;
          if (!startTimeVal || !endTimeVal) {
            window.alert('Make sure you filled all time inputs'); // Think of switching to internal alert manager
            this._closeWaiter();
            return;
          }
          const date = new Date(0),
                startTimeRegExp = startTimeVal.match(/(\d+):(\d+)/),
                endTimeRegExp = endTimeVal.match(/(\d+):(\d+)/),
                startTimeUnix = date.setUTCHours(startTimeRegExp[1], startTimeRegExp[2]),
                endTimeUnix = date.setUTCHours(endTimeRegExp[1], endTimeRegExp[2]);
          output.push({
            name: lessonName,
            classroom: this.shadowRoot.querySelector(`[l="${lessonIndex}"] .class-input`).value,
            teacher: this.shadowRoot.querySelector(`[l="${lessonIndex}"] .teacher-input`).value,
            startTime: startTimeUnix,
            endTime: endTimeUnix
          });
          this.shadowRoot.querySelector(`[l="${lessonIndex}"] .lesson-name-input`).value = undefined;
          this.shadowRoot.querySelector(`[l="${lessonIndex}"] .class-input`).value = undefined;
          this.shadowRoot.querySelector(`[l="${lessonIndex}"] .teacher-input`).value = undefined;
          this.shadowRoot.querySelector(`[l="${lessonIndex}"] .start-time-input`).value = undefined;
          this.shadowRoot.querySelector(`[l="${lessonIndex}"] .end-time-input`).value = undefined;
          if (!config[lessonName]) {
            if (availableColors.length === 0) availableColors = colorsPalette;
            config[lessonName] = { color: availableColors.pop() };
          }
        });
        this.appData.config = config;
        this.appData.timetable = this.appData.timetable || [0,0,0,0,0,0,0];
        output.forEach((item, index) => {
          output[index] = Object.keys(item)
                                .filter(key => typeof item[key] !== 'undefined')
                                .reduce((res, key) => Object.assign(res, { [key]: item[key] }), {});
        });
        this.appData.timetable[day] = output;
        if (this.weekDays.length === 0) {
          // Save and exit setup
          this.notifyPath('appData.config');
          this._fire('switch-page', { action: 'closeSetupDialog' }, false, this._shell);
        } else {
          // Open another input page for next day
          this._currentEditedDay = Number(this.weekDays.shift());
          const dayReadable = moment().day(this._currentEditedDay).format('dddd');
          this.$.daySection.children[0].textContent = `${this.localize('setup_enterLessonsOn')} ${dayReadable}`;
          this.shadowRoot.querySelector('#daySection dom-repeat').items = this._lessonsOn(this._currentEditedDay);
          this.$.main.scrollTop = 0;
        }
        this._closeWaiter();
      }
      
      _computeNewInputTeacher(e) {
        this._updateLessonsInfo('teacher', e);
      }
      
      _computeNewInputClass(e) {
        this._updateLessonsInfo('class', e);
      }
      
      _computeNewInputTime(e) {
        const val = e.target.value;
        if (!val) return;
        const lessonIndex = e.target.parentElement.parentElement.parentElement.getAttribute('l'),
              startTime = this.shadowRoot.querySelector(`[l="${lessonIndex}"] .start-time-input`),
              endTime = this.shadowRoot.querySelector(`[l="${lessonIndex}"] .end-time-input`);
        endTime.invalid = false;
        startTime.invalid = false;
        if (!startTime.value || !endTime.value) return;
        const date = new Date(0),
                     startTimeRegExp = startTime.value.match(/(\d+):(\d+)/),
                     endTimeRegExp = endTime.value.match(/(\d+):(\d+)/),
                     startTimeUnix = date.setUTCHours(startTimeRegExp[1], startTimeRegExp[2]),
                     endTimeUnix = date.setUTCHours(endTimeRegExp[1], endTimeRegExp[2]);
        if (startTimeUnix >= endTimeUnix) {
          endTime.invalid = true;
          startTime.invalid = true;
          return;
        }
        this._lessonTime = endTimeUnix - startTimeUnix;
        if (lessonIndex != 0) {
          const lastLessonVal = this.shadowRoot.querySelector(`[l="${lessonIndex - 1}"] .end-time-input`).value;
          if (!lastLessonVal) return;
          const lastLessonEndsRegExp = lastLessonVal.match(/(\d+):(\d+)/),
                lastLessonEnds = date.setUTCHours(lastLessonEndsRegExp[1], lastLessonEndsRegExp[2]);
          if (startTimeUnix <= lastLessonEnds) {
            endTime.invalid = true;
            startTime.invalid = true;
            return;
          }
          this._breakTime = startTimeUnix - lastLessonEnds;
        }
      }
      
      _updateLessonsInfo(type, e) {
        const val = e.target.value;
        if (!val) return;
        const lesson = e.target.parentElement.parentElement.firstElementChild.value;
        this._askWorker([lesson, type, val, this._lessonsInfo], 'push').then(result => this._lessonsInfo = result.data);
      }
      
      _loadLocale(locale) {
        return new Promise((resolve, reject) => {
          const el = document.createElement('script');
          el.setAttribute('defer', true);
          el.setAttribute('src', `/bower_components/moment/locale/${locale.toLowerCase()}.js`);
          el.onload = resolve;
          el.onerror = reject;
          document.head.appendChild(el);
        });
      }
      
      _fire(name, detail = null, bubbles = true, target) {
        target = target || this;
        const evt = new CustomEvent(name, { detail, bubbles });
        target.dispatchEvent(evt);
      }
      
      _askWorker(details, job = 'find') {
        return new Promise((resolve, reject) => {
          if (job !== 'find' && job !== 'push' && job !== 'calculateTime') {
            reject(new Error('Invalid job for Worker'));
            return;
          }
          const messageChannel = new MessageChannel();
          details.unshift(job);
          messageChannel.port1.onmessage = resolve;
          this._worker.postMessage(details, [messageChannel.port2]);
        });
      }
    }
    
    customElements.define(SetupDialog.is, SetupDialog);
  </script>
</dom-module>