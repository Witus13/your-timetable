<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="/bower_components/iron-image/iron-image.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html"><!-- Change for smaller package -->

<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="/bower_components/paper-fab/paper-fab.html">

<link rel="import" href="/bower_components/neon-animation/neon-animations.html"><!-- Pick only nescessary ones -->
<link rel="import" href="/bower_components/neon-animation/neon-animation-runner-behavior.html">

<link rel="import" href="yta-common-styles.html">

<!-- This can get moved in future! -->
<link rel="import" href="paper-pager.html">

<dom-module id="yta-onboarding">
  <template>
    <style include="yta-common-styles">
    
      @media (min-width: 1280px) and (orientation: landscape) {
      
        
      /*
       * Desktop styles
       */
        
        
        :host {
          @apply(--layout-horizontal);
          @apply(--layout-center);
          @apply(--layout-center-justified);
        }
        
        #main::before {
          content: "";
          background-color: rgba(0,0,0,0.6);
          position: fixed;
          top: 0;
          right: 0;
          bottom: 0;
          left: 0;
        }
        
        #main {
          @apply(--shadow-elevation-16dp);
          height: 675px;
          width: 675px;
          position: relative;
        }
        
        #main, #loginPage, div[index] {
          border-radius: 16px;
        }
        
        div[index], #loginPage {
          @apply(--layout-vertical);
        }
        
        div[text] {
          @apply(--layout-center);
        }
        
        div[images] {
          /*@apply(--layout-flex-5); # Can't use due to lack of !important */
          -ms-flex: 5 !important;
          -webkit-flex: 5 !important;
          flex: 5 !important;
        }
        
        paper-button.blue, paper-icon-button.blue {
          color: white !important;
        }
        
      }
    
      @media (min-width: 480px) and (max-width: 960px) and (orientation: landscape), (min-width: 0px) and (max-width: 600px) and (orientation: portrait) {
      
        
      /*
       * Phone styles
       */
        
        
        #main {
          @apply(--layout-fit);
        }
        
      }
      
      @media (min-width: 0px) and (max-width: 840px) and (orientation: portrait) {
        
        
      /*
       * Phone & tablet portrait styles
       */
        
        
        div[index], #loginPage {
          @apply(--layout-vertical);
        }
        
        div[text] {
          @apply(--layout-center);
        }
        
        div[text] > h2 {
          text-align: center;
        }
        
        div[text] > p {
          text-align: center;
          margin: 0 40px 0 40px;
        }
        
      }
      
      @media (min-width: 480px) and (max-width: 1279px) and (orientation: landscape) {
        
        
      /*
       * Phone & tablet landscape styles
       */
        
        
        div[index], #loginPage {
          @apply(--layout-horizontal);
        }
        
        div[text] {
          @apply(--layout-center-justified);
        }
        
        div[text] > h2 {
          text-align: left;
        }
        
        div[text] > p {
          text-align: left;
        }
        
        div[text] paper-button, #loginPage div[text] > div {
          @apply(--layout-self-start);
        }
        
      }
        
        
      /*
       * Cross-device styles
       */
      
      
      #main {
        background-color: white;
      }
      
      iron-swipeable-pages {
        @apply(--layout-fit);
      }
      
      iron-swipeable-pages, iron-swipeable-pages > * {
        overflow-x: hidden;
      }
      
      #loginPage {
        @apply(--layout-fit);
        background-color: white;
        color: black;
      }
      #loginPage h2 {
        opacity: 0.87;
      }
      #loginPage p {
        opacity: 0.54;
      }
      
      div[images] {
        @apply(--layout-flex-3);
        position: relative;
      }
      
      div[images] > iron-image {
        @apply(--layout-fit);
      }
      
      div[text] {
        @apply(--layout-flex-2);
        @apply(--layout-vertical);
        padding: 24px 24px 20px 24px;
      }
      
      div[text] > h2 {
        @apply(--paper-font-headline);
        margin: 0 !important;
      }
      
      div[text] > p {
        @apply(--paper-font-subhead);
        margin-top: 12px;
      }
      
      #loginPage > div[text] {
        padding-bottom: 0;
      }
      
      #loginPage > div[text] > paper-button[google-signin] {
        margin-bottom: 24px;
      }
      
      #loginPage > div[text] > div > paper-button.small {
        @apply(--paper-font-caption);
      }
      
      paper-button[google-signin] {
          padding: 0 12px 0 0;
          font-weight: 500;
          font-size: 14px;
          color: white;
          min-height: 40px;
          background-color: #4285F4;
          transition: background-color 200ms cubic-bezier(0.4, 0.0, 0.2, 1);
      }
      paper-button[google-signin] > img {
          height: 18px;
          width: 18px;
          padding: 8px;
          background-color: white;
          margin: 0 16px 0 4px;
          border-radius: 5px;
      }
      paper-button[google-signin].keyboard-focus {
        font-weight: 500 !important;
      }
      /* Not nesscessary to style the spinner couse it is cool by default ðŸ˜‰ */
      
      paper-button.blue, paper-icon-button.blue {
        color: var(--google-blue-500);
      }
      
      .arrow-btn {
        will-change: color;
        @apply(--shadow-transition);
        --paper-fab-keyboard-focus: black;
        --paper-fab-background: white;
        position: fixed;
        top: calc(50vh - 28px);
        transition: color 150ms cubic-bezier(0.4, 0.0, 0.2, 1);
      }
      
      /* Styling individual slides */
      
      div[index] {
        color: white;
      }
      div[index] h2 {
        opacity: 1;
      }
      div[index] p {
        opacity: 0.7;
      }
      
      div[index="0"] {
        background-color: #9575cd;
        color: white;
      }
      div[index="0"] h2 {
        opacity: 1;
      }
      div[index="0"] p {
        opacity: 0.7;
      }
      div[index="0"] paper-button {
        background-color: white;
        color: var(--paper-deep-purple-500);
      }
      
      div[index="1"] {
        background-color: #ef5350;
      }
      div[index="1"] paper-button {
        background-color: white;
        color: var(--paper-red-500);
      }
      
      div[index="2"] {
        background-color: var(--paper-blue-300);
        color: black;
      }
      div[index="2"] h2 {
        opacity: 0.87;
      }
      div[index="2"] p {
        opacity: 0.54;
      }
      div[index="2"] paper-button {
        background-color: white;
        color: var(--paper-blue-500);
      }
      div[index="2"] iron-image {
        margin: 30px;
      }
      
    </style>
    
    <div id="main">
      <div id="loginPage">
        <div images>
          <iron-image src="/images/login-image.png" preload fade sizing="contain"></iron-image>
        </div>
        <div text>
          <h2>Sign-in with Google</h2>
          <p>This allows Your Timetable to work on all of your devices</p>
          <paper-button raised google-signin on-tap="signIn">
            <template is="dom-if" if id="text">
              <img src="/images/googlelogo-big.png">Sign in with Google
            </template>
            <template is="dom-if" id="spinner">
              <paper-spinner-lite active></paper-spinner-lite>
            </template>
          </paper-button>
          <div style="display:inline-block" hidden$="[[signedIn]]">
            <paper-button class="small blue" on-tap="testDrive">Test drive</paper-button>
            <span>
              <paper-icon-button class="blue" icon="help-outline" id="helpButtonTooltipTarget" on-tap="showHelpTooltip"></paper-icon-button>
              <paper-tooltip for="helpButtonTooltipTarget" fit-to-visible-bounds manual-mode>Browse anonymously for 30 minutes</paper-tooltip>
            </span>
          </div>
        </div>
      </div>
      <template is="dom-if" id="intro" restamp if="[[signedIn]]">
        <iron-swipeable-pages id="carousel" selected="{{selected}}" no-cycle threshold="0.2" force-update items="{{pages}}">
            <div index="0" color="#9575cd">
              <div images>
                <iron-image src="/images/onboarding_s1.png" preload fade sizing="contain"></iron-image>
              </div>
              <div text>
                <h2>New way to view your timetable</h2>
                <p>Check your timetable, assigments, tests and reminders in one place.</p>
                <paper-button raised on-tap="_proceed">Get started</paper-button>
              </div>
            </div>
            <div index="1" color="#ef5350">
              <div images>
                <iron-image src="/images/onboarding_s2.png" preload fade sizing="contain"></iron-image>
              </div>
              <div text>
                <h2>On all of your devices</h2>
                <p>Check Your Timetable on all of your signed-in devices</p>
                <paper-button raised on-tap="_proceed">Get started</paper-button>
              </div>
            </div>
            <template is="dom-if" if="[[_isOfflineReady()]]">
              <div index="2" color="#64b5f6">
                <div images>
                  <iron-image src="/images/onboarding_s3.png" preload fade sizing="contain"></iron-image>
                </div>
                <div text>
                  <h2>Even offline</h2>
                  <p>Poor connection or offline? It's not a problem for Your Timetable</p>
                  <paper-button raised on-tap="_proceed">Get started</paper-button>
                </div>
              </div>
            </template>
        </iron-swipeable-pages>
        <paper-pager id="pager"
                   selected="{{selected}}"
                   items="[[pages]]"
                   style="position: absolute">
        </paper-pager>
        <template is="dom-if" if="[[desktopLayout]]" restamp>
          <paper-fab class="arrow-btn"
                     icon="arrow-back"
                     id="arrowLeft"
                     on-tap="_tapArrowLeft"
                     style="color: [[color]]"></paper-fab>
          <paper-fab class="arrow-btn"
                     icon="arrow-forward"
                     id="arrowRight"
                     on-tap="_tapArrowRight"
                     style="color: [[color]]"></paper-fab>
        </template>
      </template>
    </div>
  </template>
  
  <script>
    Polymer({
      is: 'yta-onboarding',
      
      behaviors: [
        Polymer.NeonAnimationRunnerBehavior,
        Polymer.IronResizableBehavior
      ],
      
      properties: {
        
        phoneLayout: {
          type: Boolean,
          notify: true
        },
        
        desktopLayout: {
          type: Boolean,
          notify: true
        },
        
        isActive: {
          type: Boolean,
          value: false
        },
        
        selected: {
          type: Number,
          notify: true,
          value: 0,
          observer: '_selectedChanged'
        },
        
        color: {
          type: String,
          notify: true,
          reflectToAttribute: true,
          value: '#FFFFFF',
          observer: '_colorChanged'
        },
        
        pages: {
          type: Array,
          notify: true
        },
        
        signedIn: {
          type: Boolean,
          notify: true,
          value: false
        },
        
        animationConfig: {
          value: function() { return {
            'entry': {
              name: 'slide-from-bottom-animation',
              node: this,
              timing: { duration: 300, easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)' }
            },
            'exit': {
              name: 'slide-down-animation',
              node: this,
              timing: { duration: 300, easing: 'cubic-bezier(0.4, 0.0, 1, 1)' }
            },
            'closeLogin': [
              {
                name: 'slide-left-animation',
                node: this.$.loginPage,
                timing: { duration: 300, easing: 'cubic-bezier(0.4, 0.0, 0.2, 1)' }
              },
              {
                name: 'slide-from-right-animation',
                node: this.$$('#carousel'),
                timing: { duration: 300, easing: 'cubic-bezier(0.4, 0.0, 0.2, 1)' }
              }
            ]
          } }
        }
        
      },
      
      listeners: {
        'iron-resize': 'setLayout', // To set the layout when screen size changes
        'dom-change': 'setLayout' // Little workaround dom-if rendering
      },
      
      attached: function() {
        onboarding = this;
      },
      
      open: function() {
        this.isActive = true;
        this.selected = 0;
      },
      
      close: function() {
        this.isActive = false;
        this.signedIn = false
      },
      
      signIn: function(e) {
        e.target.style.backgroundColor = '#FFF';
        var targetWidth = e.target.offsetWidth;
        e.target.style.minWidth = targetWidth + 'px';
        e.target.querySelector('#text').if = false;
        e.target.querySelector('#spinner').if = true;
        this.fire('signing-in');
        firebaseControl.signIn()
          .then(() => {
            // User signed in!
            firebaseControl.isFirstTimeVisit().then(resp => {
              if(resp) {
                this.importHref('bower_components/iron-swipeable-pages/iron-swipeable-pages.html', () => {
                  this.signedIn = true;
                  this.$.intro.render();
                  this._selectedChanged(0);
                  this.setLayout();
                  this.set('animationConfig.closeLogin.1.node', this.$$('#carousel'));
                  this.playAnimation('closeLogin');
                  this.notifyPath('color')
                });
              } else {
                this.fire('switch-page', { action: 'closeOnboarding' })
              }
            })
          }).catch(function(err) {
            // Sign in failed!
            console.warn('Sign in failed', err);
            e.target.style.backgroundColor = '#4885ed';
            e.target.querySelector('#text').if = true;
            e.target.querySelector('#spinner').if = false;
          })
      },
      
      testDrive: function() {
        firebaseControl.signInAnonymously()
          .then(() => {
            // Signed in anonymously
            //  Powerup the carousel
            this.signedIn = true;
            this.$.intro.render();
            this._selectedChanged(0);
            this.setLayout();
            this.set('animationConfig.closeLogin.1.node', this.$$('#carousel'));
            this.playAnimation('closeLogin');
            this.notifyPath('color');
            //  Set a timeout for data
            if(isChrome()) {
              // For Chrome
              window.onbeforeunload = function() {
                firebaseControl.signOut();
                return null;
              };
            } else {
              // For other browsers
              window.onbeforeunload = function() {
                return "If you will leve now your data will be lost! Sign in before leaving to save it."
              };
              window.onunload = function() {
                firebaseControl.signOut();
              };
            }
            this.async(function() {
              firebaseControl.signOut();
            }, 1.8e+6)
          }).catch(function(err) {
            // Sign in failed!
            console.warn('Sign in failed', err)
          })
      },
      
      showHelpTooltip: function() {
        var tooltip = this.$$('#loginPage paper-tooltip');
        tooltip.show();
        this.async(function() {
          tooltip.hide()
        }, 5000)
      },
      
      setLayout: function() {
        if(this.$$('#carousel')) {
          var textsNL = this.$$('#carousel').querySelectorAll('div[text] > p');
          var texts = Array.prototype.slice.call(textsNL);
          texts.forEach(function(item) {
            var output = 56;
            output -= item.offsetHeight - 24;
            item.style.marginBottom = output + 'px'
          });
          var pager = this.$$('#pager');
          var pagerPosLeft, pagerPosBottom;
          if(shell.desktopLayout) {
            pager.style.position = 'fixed';
            var main = this.$.main;
            var mainLeft = main.offsetLeft;
            var mainCenter = mainLeft + main.offsetWidth / 2;
            pagerPosLeft = mainCenter - pager.offsetWidth / 2;
            pagerPosBottom = windowOffsetBottom(main) - 24 - pager.offsetHeight;
          } else if(!this.phoneLayout || this.offsetWidth < this.offsetHeight) {
            pager.style.position = 'absolute';
            pagerPosLeft = this.offsetWidth / 2 - pager.offsetWidth / 2 - 5;
            pagerPosBottom = 10;
          } else {
            pager.style.position = 'absolute';
            var textDiv = this.$$('#carousel div[text] paper-button');
            pagerPosLeft = textDiv.offsetLeft + (textDiv.offsetWidth / 2 - pager.offsetWidth / 2 - 5);
            var buttonBottom = this.offsetHeight - (textDiv.offsetTop + textDiv.offsetHeight);
            pagerPosBottom = buttonBottom - 20 - pager.offsetHeight - 10;
          }
          pager.style.left = pagerPosLeft + 'px';
          pager.style.bottom = pagerPosBottom + 'px';
          if(this.desktopLayout) {
            var arrowLeftPos, arrowRightPos;
            var mainLeft = this.$.main.offsetLeft;
            var mainRight = mainLeft + this.$.main.offsetWidth;
            arrowLeftPos = mainLeft - 56 - 48;
            arrowRightPos = mainRight + 48;
            this.$$('#arrowLeft').style.left = arrowLeftPos + 'px';
            this.$$('#arrowRight').style.left = arrowRightPos + 'px';
          }
        };
        var textsNL = this.root.querySelectorAll('#loginPage > div[text] > p');
        var texts = Array.prototype.slice.call(textsNL);
        texts.forEach(function(item) {
          var output = 56;
          output -= item.offsetHeight - 24;
          item.style.marginBottom = output + 'px'
        });
      },
      
      _selectedChanged: function(selected) {
        if(this.$$('#carousel')) {
          var el = this.$$(['div[index="', selected, '"]'].join(''));
          this.color = el.getAttribute('color');
        }
      },
      
      _colorChanged: function(color) {
        document.head.querySelector('#themeColor').setAttribute('content', color);
        if(this.signedIn) {
          if(this.desktopLayout) {
            this.$$('#pager').customStyle['--paper-pager-color'] = color;
          } else {
            this.$$('#pager').customStyle['--paper-pager-color'] = 'white';
          }
          this.$$('#pager').updateStyles();
        }
      },
      
      _isOfflineReady: function() {
        return 'serviceWorker' in navigator
      },
      
      _proceed: function() {
        this.fire('switch-page', { action: 'closeOnboarding' });
        this.fire('switch-page', { action: 'openSetupDialog' });
      },
      
      _tapArrowRight: function(e) {
        /*if(this.selected == (this.pages.length - 2)) {
          e.target.icon = 'check'
        } else {
          e.target.icon = 'arrow-forward'
        };*/
        if(this.selected != (this.pages.length - 1)) {
          this.selected++
        } else {
          this._proceed()
        }
      },
      
      _tapArrowLeft: function() {
        /*if(this.selected == 1) {
          e.target.disabled = true
        } else {
          e.target.disabled = false
        };*/
        if(this.selected != 0) {
          this.selected--
        }
      }
    })
    
    // Nescessary one
    function windowOffsetBottom(item) {
      var elemHeight = item.offsetHeight;
      var elemTop = item.offsetTop;
      var windowHeight = window.innerHeight;
      return windowHeight - (elemTop + elemHeight);
    }
  </script>
</dom-module>