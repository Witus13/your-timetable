<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/polymer/src/templatizer/dom-bind.html">

<link rel="import" href="/bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="/bower_components/iron-swipeable-pages/iron-swipeable-pages.html">

<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="/bower_components/paper-pager/paper-pager.html">
<link rel="import" href="/bower_components/paper-styles/paper-styles.html">

<link rel="import" href="/bower_components/neon-animation/neon-animations.html"><!-- Pick only nescessary ones -->
<link rel="import" href="/bower_components/neon-animation/neon-animation-runner-behavior.html">

<link rel="import" href="icons.html">

<dom-module id="yta-onboarding">
  <template>
    <style>
      
      
      
    </style>
    
    
  </template>
  
  <script>
    class Onboarding extends /*Polymer.IronResizableBehavior(*/Polymer.Element/*)*/ {
      static get is() { return 'yta-onboarding'; }
      static get config() {
        return {
          properties: {
            
            // Inherited from Shell
            phoneLayout: {
              type: Boolean,
              notify: true
            },
            
            // Inherited from shell
            tabletLayout: {
              type: Boolean,
              notify: true
            },
            
            // Inherited from shell
            desktopLayout: {
              type: Boolean,
              notify: true
            },
            
            /* NOT SURE IF NESSCESSARY
            // Boolean indicating state of element
            isActive: {
              type: Boolean,
              value: false
            },*/
            
            // Selected page
            selected: {
              type: Number,
              notify: true,
              value: 0,
              observer: '_selectedChanged'
            },
            
            // Color of current page
            color: {
              type: String,
              notify: true,
              reflectToAttribute: true,
              value: '#FFFFFF',
              observer: '_colorChanged'
            },
            
            // List of pages
            pages: {
              type: Array,
              notify: true
            }
            
          }
        };
      }
      
      constructor() {
        super();
      }
      
      ready() {
        super.ready();
        
        // Add event listeners
        this.addEventListener('iron-resize', () => this.setLayout());
      }
      
      connectedCallback() {
        super.connectedCallback();
        
        this._shell = this.parentElement;
        
        // Add event listeners
        this._shell.addEventListener('open-onboarding', () => this.open());
        this._shell.addEventListener('close-onboarding', () => this.close());
        
        // Set up animation config
        this.animationConfig = {
          'entry': {
            name: 'slide-from-bottom-animation',
            node: this,
            timing: {
              duration: 300,
              easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
            }
          },
          'exit': {
            name: 'slide-down-animation',
            node: this,
            timing: {
              duration: 300,
              easing: 'cubic-bezier(0.4, 0.0, 1, 1)'
            }
          }
        };
        
        // Ensure correct display viewport
        this.setLayout();
      }
      
      disconnectedCallback() {
        if (!this._shell) return;
        
        // Remove event listeners
        this._shell.removeEventListener('open-onboarding', () => this.open());
        this._shell.removeEventListener('close-onboarding', () => this.close());
      }
      
      _signIn() {
        const evt = new CustomEvent('FIREBASE-sign-in-required', { detail: { provider: 'google' } });
        window.dispatchEvent(evt, { bubbles: true });
        this._addListenerFotSignIn();
      }
      
      _signInAnonymously() {
        const evt = new CustomEvent('FIREBASE-sign-in-required', { detail: { provider: 'google' } });
        window.dispatchEvent(evt, { bubbles: true });
        this._addListenerFotSignIn();
      }
      
      _addListenerFotSignIn() {
        window.addEventListener()                                                                   // START HERE
      }
      
      _fire(name, details = null, bubbles = true) {
        const evt = new CustomEvent(name, { detail: details });
        this.dispatchEvent(evt, { bubbles });
      }
    }
    
    customElements.define(Onboarding.is, Onboarding);
    
    // OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD OLD
    Polymer({
      is: 'yta-onboarding',
      
      behaviors: [
        Polymer.NeonAnimationRunnerBehavior,
        Polymer.IronResizableBehavior
      ],
      
      properties: {
        
        phoneLayout: {
          type: Boolean,
          notify: true
        },
        
        desktopLayout: {
          type: Boolean,
          notify: true
        },
        
        isActive: {
          type: Boolean,
          value: false
        },
        
        selected: {
          type: Number,
          notify: true,
          value: 0,
          observer: '_selectedChanged'
        },
        
        color: {
          type: String,
          notify: true,
          reflectToAttribute: true,
          value: '#FFFFFF',
          observer: '_colorChanged'
        },
        
        pages: {
          type: Array,
          notify: true
        },
        
        signedIn: {
          type: Boolean,
          notify: true,
          value: false
        },
        
        animationConfig: {
          value: function() { return {
            'entry': {
              name: 'slide-from-bottom-animation',
              node: this,
              timing: { duration: 300, easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)' }
            },
            'exit': {
              name: 'slide-down-animation',
              node: this,
              timing: { duration: 300, easing: 'cubic-bezier(0.4, 0.0, 1, 1)' }
            },
            'closeLogin': [
              {
                name: 'slide-left-animation',
                node: this.$.loginPage,
                timing: { duration: 300, easing: 'cubic-bezier(0.4, 0.0, 0.2, 1)' }
              },
              {
                name: 'slide-from-right-animation',
                node: this.$$('#carousel'),
                timing: { duration: 300, easing: 'cubic-bezier(0.4, 0.0, 0.2, 1)' }
              }
            ]
          } }
        }
        
      },
      
      listeners: {
        'iron-resize': 'setLayout', // To set the layout when screen size changes
        'dom-change': 'setLayout' // Little workaround dom-if rendering
      },
      
      attached: function() {
        onboarding = this;
      },
      
      open: function() {
        this.isActive = true;
        this.selected = 0;
      },
      
      close: function() {
        this.isActive = false;
        this.signedIn = false
      },
      
      signIn: function(e) {
        e.target.style.backgroundColor = '#FFF';
        var targetWidth = e.target.offsetWidth;
        e.target.style.minWidth = targetWidth + 'px';
        e.target.querySelector('#text').if = false;
        e.target.querySelector('#spinner').if = true;
        this.fire('signing-in');
        firebaseControl.signIn()
          .then(() => {
            // User signed in!
            firebaseControl.isFirstTimeVisit().then(resp => {
              if(resp) {
                this.importHref('bower_components/iron-swipeable-pages/iron-swipeable-pages.html', () => {
                  this.signedIn = true;
                  this.$.intro.render();
                  this._selectedChanged(0);
                  this.setLayout();
                  this.set('animationConfig.closeLogin.1.node', this.$$('#carousel'));
                  this.playAnimation('closeLogin');
                  this.notifyPath('color')
                });
              } else {
                this.fire('switch-page', { action: 'closeOnboarding' })
              }
            })
          }).catch(function(err) {
            // Sign in failed!
            console.warn('Sign in failed', err);
            e.target.style.backgroundColor = '#4885ed';
            e.target.querySelector('#text').if = true;
            e.target.querySelector('#spinner').if = false;
          })
      },
      
      testDrive: function() {
        firebaseControl.signInAnonymously()
          .then(() => {
            // Signed in anonymously
            //  Powerup the carousel
            this.signedIn = true;
            this.$.intro.render();
            this._selectedChanged(0);
            this.setLayout();
            this.set('animationConfig.closeLogin.1.node', this.$$('#carousel'));
            this.playAnimation('closeLogin');
            this.notifyPath('color');
            //  Set a timeout for data
            if(isChrome()) {
              // For Chrome
              window.onbeforeunload = function() {
                firebaseControl.signOut();
                return null;
              };
            } else {
              // For other browsers
              window.onbeforeunload = function() {
                return "If you will leve now your data will be lost! Sign in before leaving to save it."
              };
              window.onunload = function() {
                firebaseControl.signOut();
              };
            }
            this.async(function() {
              firebaseControl.signOut();
            }, 1.8e+6)
          }).catch(function(err) {
            // Sign in failed!
            console.warn('Sign in failed', err)
          })
      },
      
      showHelpTooltip: function() {
        var tooltip = this.$$('#loginPage paper-tooltip');
        tooltip.show();
        this.async(function() {
          tooltip.hide()
        }, 5000)
      },
      
      setLayout: function() {
        if(this.$$('#carousel')) {
          var textsNL = this.$$('#carousel').querySelectorAll('div[text] > p');
          var texts = Array.prototype.slice.call(textsNL);
          texts.forEach(function(item) {
            var output = 56;
            output -= item.offsetHeight - 24;
            item.style.marginBottom = output + 'px'
          });
          var pager = this.$$('#pager');
          var pagerPosLeft, pagerPosBottom;
          if(Onboarding.desktopLayout) {
            pager.style.position = 'fixed';
            var main = this.$.main;
            var mainLeft = main.offsetLeft;
            var mainCenter = mainLeft + main.offsetWidth / 2;
            pagerPosLeft = mainCenter - pager.offsetWidth / 2;
            pagerPosBottom = windowOffsetBottom(main) - 24 - pager.offsetHeight;
          } else if(!this.phoneLayout || this.offsetWidth < this.offsetHeight) {
            pager.style.position = 'absolute';
            pagerPosLeft = this.offsetWidth / 2 - pager.offsetWidth / 2 - 5;
            pagerPosBottom = 10;
          } else {
            pager.style.position = 'absolute';
            var textDiv = this.$$('#carousel div[text] paper-button');
            pagerPosLeft = textDiv.offsetLeft + (textDiv.offsetWidth / 2 - pager.offsetWidth / 2 - 5);
            var buttonBottom = this.offsetHeight - (textDiv.offsetTop + textDiv.offsetHeight);
            pagerPosBottom = buttonBottom - 20 - pager.offsetHeight - 10;
          }
          pager.style.left = pagerPosLeft + 'px';
          pager.style.bottom = pagerPosBottom + 'px';
          if(this.desktopLayout) {
            var arrowLeftPos, arrowRightPos;
            var mainLeft = this.$.main.offsetLeft;
            var mainRight = mainLeft + this.$.main.offsetWidth;
            arrowLeftPos = mainLeft - 56 - 48;
            arrowRightPos = mainRight + 48;
            this.$$('#arrowLeft').style.left = arrowLeftPos + 'px';
            this.$$('#arrowRight').style.left = arrowRightPos + 'px';
          }
        };
        var textsNL = this.root.querySelectorAll('#loginPage > div[text] > p');
        var texts = Array.prototype.slice.call(textsNL);
        texts.forEach(function(item) {
          var output = 56;
          output -= item.offsetHeight - 24;
          item.style.marginBottom = output + 'px'
        });
      },
      
      _selectedChanged: function(selected) {
        if(this.$$('#carousel')) {
          var el = this.$$(['div[index="', selected, '"]'].join(''));
          this.color = el.getAttribute('color');
        }
      },
      
      _colorChanged: function(color) {
        document.head.querySelector('#themeColor').setAttribute('content', color);
        if(this.signedIn) {
          if(this.desktopLayout) {
            this.$$('#pager').customStyle['--paper-pager-color'] = color;
          } else {
            this.$$('#pager').customStyle['--paper-pager-color'] = 'white';
          }
          this.$$('#pager').updateStyles();
        }
      },
      
      _isOfflineReady: function() {
        return 'serviceWorker' in navigator
      },
      
      _proceed: function() {
        this.fire('switch-page', { action: 'closeOnboarding' });
        this.fire('switch-page', { action: 'openSetupDialog' });
      },
      
      _tapArrowRight: function(e) {
        /*if(this.selected == (this.pages.length - 2)) {
          e.target.icon = 'check'
        } else {
          e.target.icon = 'arrow-forward'
        };*/
        if(this.selected != (this.pages.length - 1)) {
          this.selected++
        } else {
          this._proceed()
        }
      },
      
      _tapArrowLeft: function() {
        /*if(this.selected == 1) {
          e.target.disabled = true
        } else {
          e.target.disabled = false
        };*/
        if(this.selected != 0) {
          this.selected--
        }
      }
    })
    
    // Nescessary one
    function windowOffsetBottom(item) {
      var elemHeight = item.offsetHeight;
      var elemTop = item.offsetTop;
      var windowHeight = window.innerHeight;
      return windowHeight - (elemTop + elemHeight);
    }
  </script>
</dom-module>