<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html"><!-- Change for smaller package -->

<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">

<link rel="import" href="../bower_components/neon-animation/neon-animations.html"><!-- Pick only nescessary ones -->
<link rel="import" href="../bower_components/neon-animation/neon-animation-runner-behavior.html">

<link rel="import" href="yta-common-styles.html">

<dom-module id="yta-onboarding">
  <template>
    <style include="yta-common-styles">
    
      @media (min-width: 480px) and (max-width: 960px) and (orientation: landscape), (min-width: 0px) and (max-width: 600px) and (orientation: portrait) {
      
        
      /*
       * Phone styles
       */
        
        
        #main {
          @apply(--layout-fit);
        }
        
      }
      
      @media (min-width: 0px) and (max-width: 840px) and (orientation: portrait) {
        
        
      /*
       * Phone & tablet portrait styles
       */
        
        
        div[index], #loginPage {
          @apply(--layout-vertical);
        }
        
      }
      
      @media (min-width: 480px) and (max-width: 1280px) and (orientation: landscape) {
        
        
      /*
       * Phone & tablet landscape styles
       */
        
        
        div[index], #loginPage {
          @apply(--layout-horizontal);
        }
        
        div[text] {
          @apply(--layout-center-justified);
        }
        
      }
        
        
      /*
       * Cross-device styles
       */
      
      
      #main {
        @apply(--shadow-elevation-24dp);
        background-color: white;
      }
      
      iron-swipeable-pages {
        @apply(--layout-fit);
      }
      
      iron-swipeable-pages, iron-swipeable-pages > * {
        overflow-x: hidden;
      }
      
      #loginPage {
        @apply(--layout-fit);
        background-color: white;
      }
      #loginPage h2 {
        opacity: 0.87;
      }
      #loginPage p {
        opacity: 0.54;
      }
      
      div[images] {
        @apply(--layout-flex-3);
        position: relative;
      }
      
      div[images] > iron-image {
        @apply(--layout-fit);
      }
      
      div[text] {
        @apply(--layout-flex-2);
        @apply(--layout-vertical);
        @apply(--layout-center);
        padding: 24px 24px 20px 24px;
      }
      
      div[text] > h2 {
        @apply(--paper-font-headline);
        margin: 0 0 18px 0;
      }
      
      div[text] > p {
        @apply(--paper-font-subhead);
        text-align: center;
        margin: 0 40px 0 40px;
      }
      
      #loginPage > div[text] {
        padding-bottom: 0;
      }
      
      #loginPage > div[text] > paper-button[google-signin] {
        margin-bottom: 24px;
      }
      
      #loginPage > div[text] > div > paper-button.small {
        @apply(--paper-font-caption);
      }
      
      paper-button[google-signin] {
          padding: 0 12px 0 0;
          font-weight: 500;
          font-size: 14px;
          color: white;
          min-height: 40px;
          background-color: #4285F4;
          transition: background-color 200ms cubic-bezier(0.4, 0.0, 0.2, 1);
      }
      paper-button[google-signin] > img {
          height: 18px;
          width: 18px;
          padding: 8px;
          background-color: white;
          margin: 0 16px 0 4px;
          border-radius: 5px;
      }
      paper-button[google-signin].keyboard-focus {
        font-weight: 500 !important;
      }
      /* Not nesscessary to style the spinner couse it is cool by default ;) */
      
      paper-button.blue, paper-icon-button.blue {
        color: var(--google-blue-500);
      }
      
      /* Styling individual slides */
      
      div[index="0"] {
        background-color: #9575cd;
        color: white;
      }
      div[index="0"] h2 {
        opacity: 1;
      }
      div[index="0"] p {
        opacity: 0.7;
      }
      
      div[index="1"] {
        background-color: #ef5350;
      }
      
    </style>
    
    <div id="main">
      <div id="loginPage">
        <div images>
          <iron-image src="../images/login-image.png" preload fade sizing="contain"></iron-image>
        </div>
        <div text>
          <h2>Sign-in with Google</h2>
          <p>This allows Your Timetable to work on all of your devices</p>
          <paper-button raised google-signin on-tap="signIn">
            <template is="dom-if" if id="text">
              <img src="../images/googlelogo-big.png">Sign in with Google
            </template>
            <template is="dom-if" id="spinner">
              <paper-spinner-lite active></paper-spinner-lite>
            </template>
          </paper-button>
          <div style="display:inline-block">
            <paper-button class="small blue" on-tap="testDrive">Test drive</paper-button>
            <span>
              <paper-icon-button class="blue" icon="help-outline" id="helpButtonTooltipTarget" on-tap="showHelpTooltip"></paper-icon-button>
              <paper-tooltip for="helpButtonTooltipTarget" fit-to-visible-bounds manual-mode>Browse anonymously for 30 minutes</paper-tooltip>
            </span>
          </div>
        </div>
      </div>
      <template is="dom-if" id="intro" restamp>
        <iron-swipeable-pages id="carousel" selected="{{selected}}" no-cycle threshold="0.2" force-update>
            <div index="0" color="#9575cd">
              <div images>
                <iron-image src="../images/onboarding_s1.png" preload fade sizing="contain"></iron-image>
              </div>
              <div text>
                <h2>A new way to view your timetable</h2>
                <p>Check your timetable, assigments, tests and reminders in right place, at right time.</p>
                <paper-button on-tap="_proceed">Get started</paper-button>
              </div>
            </div>
            <div index="1" color="#ef5350">
              2
            </div>
        </iron-swipeable-pages>
      </template>
    </div>
  </template>
  
  <script>
    Polymer({
      is: 'yta-onboarding',
      
      behaviors: [
        Polymer.NeonAnimationRunnerBehavior,
        Polymer.IronResizableBehavior
      ],
      
      properties: {
        
        phoneLayout: {
          type: Boolean,
          notify: true
        },
        
        isActive: {
          type: Boolean,
          value: false
        },
        
        selected: {
          type: Number,
          notify: true,
          value: 0,
          observer: '_selectedChanged'
        },
        
        color: {
          type: String,
          notify: true,
          reflectToAttribute: true,
          value: '#FFFFFF',
          observer: '_colorChanged'
        },
        
        animationConfig: {
          value: function() { return {
            'entry': {
              name: 'slide-from-bottom-animation',
              node: this,
              timing: { duration: 225, easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)' }
            },
            'exit': {
              name: 'slide-down-animation',
              node: this,
              timing: { duration: 195, easing: 'cubic-bezier(0.4, 0.0, 1, 1)' }
            },
            'closeLogin': [
              {
                name: 'slide-left-animation',
                node: this.$.loginPage,
                timing: { duration: 300, easing: 'cubic-bezier(0.4, 0.0, 0.2, 1)' }
              },
              {
                name: 'slide-from-right-animation',
                node: this.$$('#carousel'),
                timing: { duration: 300, easing: 'cubic-bezier(0.4, 0.0, 0.2, 1)' }
              }
            ]
          } }
        }
        
      },
      
      listeners: {
        'iron-resize': 'setLayout' // To set the layout when screen size changes
      },
      
      attached: function() {
        onboarding = this;
      },
      
      open: function() {
        this.isActive = true;
        this.selected = 0;
      },
      
      close: function() {
        this.isActive = false;
        this.$.intro.if = false
      },
      
      signIn: function(e) {
        e.target.style.backgroundColor = '#FFF';
        var targetWidth = e.target.offsetWidth;
        e.target.style.minWidth = targetWidth + 'px';
        e.target.querySelector('#text').if = false;
        e.target.querySelector('#spinner').if = true;
        this.fire('signing-in');
        firebaseControl.signIn()
          .then(() => {
            // User signed in!
            firebaseControl.isFirstTimeVisit().then(resp => {
              if(resp) {
                this.importHref('bower_components/iron-swipeable-pages/iron-swipeable-pages.html', () => {
                  this.$.intro.if = true;
                  this.$.intro.render();
                  this._selectedChanged(0);
                  this.set('animationConfig.closeLogin.1.node', this.$$('#carousel'));
                  this.playAnimation('closeLogin');
                });
              } else {
                this.fire('switch-page', { action: 'closeOnboarding' })
              }
            })
          }).catch(function(err) {
            // Sign in failed!
            console.warn('Sign in failed', err);
            e.target.style.backgroundColor = '#4885ed';
            e.target.querySelector('#text').if = true;
            e.target.querySelector('#spinner').if = false;
          })
      },
      
      testDrive: function() {
        firebaseControl.signInAnonymously()
          .then(() => {
            // Signed in anonymously
            //  Powerup the carousel
            this.$.intro.if = true;
            this.$.intro.render();
            this._selectedChanged(0);
            this.set('animationConfig.closeLogin.1.node', this.$$('#carousel'));
            this.playAnimation('closeLogin');
            //  Set a timeout for data
            window.onbeforeunload = function() {
              return "If you will leve now your data will be lost! Sign in before leaving to save it."
            };
            window.onunload = function() {
              firebaseControl.signOut();
            };
            anonymousUser.async = onboarding.async(function() {
              firebaseControl.signOut();
            }, 1.8e+6)
          }).catch(function(err) {
            // Sign in failed!
            console.warn('Sign in failed', err)
          })
      },
      
      showHelpTooltip: function() {
        var tooltip = this.$$('#loginPage paper-tooltip');
        tooltip.show();
        this.async(function() {
          tooltip.hide()
        }, 5000)
      },
      
      setLayout: function() {
        if(this.$$('#carousel')) {
          var textsNL = this.$$('#carousel').querySelectorAll('div[text] > p');
          var texts = Array.prototype.slice.call(textsNL);
          texts.forEach(function(item) {
            var output = 56;
            output -= item.offsetHeight - 24;
            item.style.marginBottom = output + 'px'
          });
        };
        var textsNL = this.root.querySelectorAll('#loginPage > div[text] > p');
        var texts = Array.prototype.slice.call(textsNL);
        texts.forEach(function(item) {
          var output = 56;
          output -= item.offsetHeight - 24;
          item.style.marginBottom = output + 'px'
        });
      },
      
      _selectedChanged: function(selected) {
        if(this.$$('#carousel')) {
          var el = this.$$(['div[index="', selected, '"]'].join(''));
          this.color = el.getAttribute('color');
        }
      },
      
      _colorChanged: function(color) {
        document.head.querySelector('#themeColor').setAttribute('content', color);
      }
    })
  </script>