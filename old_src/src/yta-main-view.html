<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-layout/app-layout.html">

<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<!-- <link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html"> # included in yta-layout-styles # -->

<link rel="import" href="../bower_components/iron-swipeable-pages/iron-swipeable-pages.html">

<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-styles/shadow.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../bower_components/neon-animation/neon-animations.html"><!-- Pick only nescessary ones -->
<link rel="import" href="../bower_components/neon-animation/neon-animation-runner-behavior.html">

<link rel="import" href="../bower_components/paper-fab-transitions/paper-fab-morph.html">

<link rel="import" href="yta-lesson-card.html">
<link rel="import" href="yta-database-controller.html">

<link rel="import" href="../styles/yta-layout-styles.html">

<dom-module id="yta-main-view">
  <template>
    <style include="yta-layout-styles"></style>
    <style>
      
      :host {
        -moz-user-select: none;
        -ms-user-select: none;
        -webkit-user-select: none;
        user-select: none;
        overflow: hidden;
        @apply(--font-common-base);
      }
      
      @media (max-width: 960px) {
        #fab, #fabMimic {
          bottom: 16px !important;
          right: 16px !important;
          top: initial !important;
          z-index: initial !important;
          position: absolute !important;
        }
        
        iron-icon.drawer-menu {
          padding-left: 0px !important;
        }
        
        div#overview {
          @apply(--layout-vertical);
          @apply(--layout-center);
        }
        
        yta-lesson-card {
          width: calc(100% - 32px) !important;
          height: initial !important;
        }
      }
      
      app-header {
        background-color: var(--primary-color);
        color: white;
      }
      
      paper-dialog {
        border-radius: 2px;
      }
      
      hr {
        border-color: var(--divider-color);
        border-width: 1px 0 0 0;
      }
      
      div[content] {
        position: relative;
      }
      
      paper-ripple {
        color: var(--primary-color);
      }
      
      paper-tabs {
        @apply(--layout-self-end);
        @apply(--layout-flex);
        padding: 0 175px;
        text-transform: uppercase;
        
      }
      
      yta-lesson-card {
        margin: 8px;
        width: 175px;
        height: 175px;
      }
      
      iron-swipeable-pages > div {
        height: 100%;
      }
      
      a {
        color: inherit;
        background-color: inherit;
        text-decoration: none;
      }
      
      paper-button.accent-colored {
        color: var(--accent-color);
      }
      
      paper-fab-morph /deep/ #morpher {
        z-index: 1000;
      }
      
      addDialog.fullscreen {
        @apply(--layout-fit)
      }
      
      a.colored {
        color: var(--primary-color) !important;
      }
      
      div[title] {
        @apply(--paper-font-title);
      }
      
      div.drawer-header.title {
        color: var(--primary-text-color);
        margin: 0px;
      }
      
      #fab, #fabMimic {
        --paper-fab-iron-icon: {
          color: black;
          opacity: var(--dark-primary-opacity);
        };
        position: fixed;
        top: 100px;
        right: 24px;
        z-index: 1;
      }
      
      #loading {
        @apply(--layout-self-center);
        height: 30px;
        width: 30px;
      }
      
      #signInButton {
        padding: 11px 8px;
        margin-bottom: 16px;
      }
      
      div#overview {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        @apply(--layout-wrap);
        background-color: var(--primary-body-color);
        padding: 8px 0px;
      }
      
      paper-item.drawer-menu {
        --paper-item-focused-before: {
          background: none;
        };
      }
      
      paper-item.nav-menu[aria-selected] > iron-icon {
        opacity: var(--dark-primary-opacity);
      }
      
      iron-icon.drawer-menu {
        opacity: var(--dark-secondary-opacity);
        padding-right: 32px;
        padding-left: 8px;
      }
      
      paper-menu#drawerMenu {
        --paper-menu-selected-item: { color: var(--primary-color); };
      }
      
      paper-menu#drawerMenuShortcuts {
        --paper-menu-selected-item: { font-weight: initial; };
        --paper-menu-focused-item-after: {
          background: none;
        };
      }
      
      paper-toolbar#drawerHeader {
        --paper-toolbar-background: white;
        border-bottom: 1px solid var(--divider-color);
      }
      
      /* Cleaned styles 
        @info: Clean other styles and delete this section 
      */
      
      /* Global styles */
      
      neon-animated-pages > * {
        @apply(--layout-fit)
      }
      
      neon-animated-pages > * {
        display: block !important;
      }
      
    </style>
    
    
    <firebase-app auth-domain="your-timetable.firebaseapp.com"
                  database-url="https://your-timetable.firebaseio.com/"
                  api-key="AIzaSyDaMune3u4WZMti3aB66FWjX9aA_lWTLkQ"></firebase-app>
    <firebase-auth id="fAuth" provider="google" user="{{fUser}}"></firebase-auth>
    <yta-database-controller id="database" data="{{data}}" uid="{{fUser.uid}}"></yta-database-controller>
    
    <yta-onboarding id="onboarding"></yta-onboarding>
    
    <paper-dialog id="addDialogCanceled">
       <div>
         Discard changes?
       </div>
       <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>Discard</paper-button>
       </div>
    </paper-dialog>
    
    <paper-dialog id="signInDialog" modal>
      <h2>Sign in</h2>
      <div style="text-align:center">
        <paper-button raised id="signInButton" on-tap="_signInToFirebase">
          <img src="../images/google-logo_big.png" style="height:18px;width:18px;vertical-align:middle">
          <span style="padding-left:24px;font-size:14px;color:rgba(0,0,0,0.54)">
            Sign in with Google
          </span>
        </paper-button>
        <br>
        <paper-button style="font-size:12px;color:#673AB7" dialog-dismiss>Sign in later</paper-button>
      </div>
    </paper-dialog>
    
    <neon-animated-pages id="sectionSwitcher" selected="{{activeSection}}">
      
      <neon-animatable section-id="main">
        
        <app-drawer-layout force-narrow fullbleed>
          <app-drawer id="drawer">
            <paper-menu id="drawerMenu" selected="{{selected}}" attr-for-selected="key">
              <paper-item key="overview" class="drawer-menu nav-menu">
                <iron-icon icon="home" class="drawer-menu"></iron-icon> Overview
              </paper-item>
              <paper-item key="timetable" class="drawer-menu nav-menu">
                <iron-icon icon="timeline" class="drawer-menu"></iron-icon> Timetable
              </paper-item>
              <paper-item key="teachers" class="drawer-menu nav-menu">
                <iron-icon icon="social:school" class="drawer-menu"></iron-icon> Teachers
              </paper-item>
              <paper-item key="calendar" class="drawer-menu nav-menu">
                <iron-icon icon="event" class="drawer-menu"></iron-icon> Calendar
              </paper-item>
            </paper-menu>
            <hr noshade>
            <paper-menu id="drawerMenuShortcuts">
              <paper-item class="drawer-menu" on-tap="openSettings">
                <iron-icon icon="settings" class="drawer-menu"></iron-icon> Settings
              </paper-item>
              <paper-item class="drawer-menu" on-tap="sendFeedback">
                <iron-icon icon="send" class="drawer-menu"></iron-icon> Send feedback
              </paper-item>
              <paper-item class="drawer-menu" on-tap="openHelp">
                <iron-icon icon="help" class="drawer-menu"></iron-icon> Help
              </paper-item>
            </paper-menu>
          </app-drawer>
          
          <app-header-layout> 
            <app-header id="header" fixed shadow>
              <app-toolbar>
                <paper-icon-button icon="menu" hidden$="{{smallLayout}}" drawer-toggle></paper-icon-button>
                <div title>Your Timetable</div>
                <paper-menu-button hidden$="{{!smallLayout}}" horizontal-align="right" id="optionsButton">
                  <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
                  <paper-menu class="dropdown-content">
                    <paper-item on-tap="openSettings">Settings</paper-item>
                    <paper-item on-tap="sendFeedback">Feedback</paper-item>
                    <paper-item on-tap="openHelp">Help</paper-item>
                  </paper-menu>
                </paper-menu-button>
              </app-toolbar>
              <app-toolbar bottom-item hidden$="{{!smallLayout}}">
                <paper-tabs selected="{{selected}}" attr-for-selected="key">
                  <paper-tab key="overview">overview</paper-tab>
                  <paper-tab key="timetable">timetable</paper-tab>
                  <paper-tab key="teachers">teachers</paper-tab>
                  <paper-tab key="calendar">calendar</paper-tab>
                </paper-tabs>
              </app-toolbar>
            </app-header>
            
            <div content>
              <iron-swipeable-pages id="ironSwipeablePages"
                                    edge-swipe-sensitivity="30"
                                    selected="{{selected}}"
                                    attr-for-selected="id">
                <div id="overview" scroll-target="document">
                  <paper-spinner active id="loading"></paper-spinner>
                  <template is="dom-repeat" items="{{lessonsToday(data.timetable)}}">
                    <yta-lesson-card item="{{item}}"
                                     index="{{index}}"
                                     colors="{{data.settings.colors}}"
                                     desktop="{{smallLayout}}"></yta-lesson-card>
                  </template>
                </div>
                <div id="timetable" scroll-target="document">
                  2
                </div>
                <div id="teachers" scroll-target="document">
                  3
                </div>
                <div id="calendar" scroll-target="document">
                  4
                </div>
              </iron-swipeable-pages>
              <paper-fab id="fab" icon="add" on-tap="openAddDialog"></paper-fab>
            </div>
          </app-header-layout>
        </app-drawer-layout>
      
      </neon-animatable>
      
    </neon-animated-pages>
    
  </template>
  
  <script>
    Polymer({
      is: 'yta-main-view',
      
      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior,
        Polymer.NeonAnimationRunnerBehavior,
        Polymer.IronResizableBehavior
      ],
      
      properties: {
        smallLayout: {
          type: Boolean,
          notify: true
        },
        
        selected: {
          type: String,
          value: 'overview',
          reflectToAttribute: true,
          notify: true
        },
        
        data: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },
        
        fUser: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },
        
        activeSection: {
          type: String,
          value: 'main',
          notify: true
        },
        
        animationConfig: {
          value: function() { return {
            'entry': [
              {
                name: 'fade-in-animation',
                node: this.$.ironSwipeablePages
              },
              {
                name: 'scale-up-animation',
                node: this.$.fab
              },
              {
                name: 'slide-from-top-animation',
                node: this.$.header
              }
            ],
            'exit': {
              name: 'fade-out-animation',
              node: this
            }
          } }
        }
        
      },
      
      listeners: {
        'iron-resize': 'setLayout',
        'setup-required': 'setup',
        'drawerMenu.tap': 'closeDrawer',
        'drawerMenuShortcuts.tap': 'closeDrawer',
        'signInDialog.iron-overlay-closed': '_onSignInClosed',
        'addDialog.iron-overlay-closed': '_onAddDialogClosed',
        'addDialog.iron-overlay-canceled': '_onAddDialogCanceled',
        'addDialogCanceled.iron-overlay-closed': '_onAddDialogCanceledClosed'
      },
      
      observers: [
        '_onDataChange(data.timetable)'
      ],
      
      ready: function() {
        // Notify that app loaded
        console.log('The app\'s main page has loaded!');
        // Set dialog's animations
        //  addDialogCanceled
        this.$.addDialogCanceled.animationConfig = {
          'entry': [
            {
              name: 'fade-in-animation',
              node: this.$.addDialogCanceled,
              timing: { duration: 75 },
            },
            {
              name: 'slide-from-bottom-animation',
              node: this.$.addDialogCanceled,
              timing: { duration: 225, easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)' },
            }
          ],
          'exit': [
            {
              name: 'fade-out-animation',
              node: this.$.addDialogCanceled,
              timing: { duration: 50, delay: 140 },
            },
            {
              name: 'slide-down-animation',
              node: this.$.addDialogCanceled,
              timing: { duration: 195, easing: 'cubic-bezier(0.4, 0.0, 1, 1)' },
            }
          ]
        };
        //  signInDialog
        this.$.signInDialog.animationConfig = {
          'entry': [
            {
              name: 'fade-in-animation',
              node: this.$.signInDialog,
              timing: { duration: 75 },
            },
            {
              name: 'slide-from-bottom-animation',
              node: this.$.signInDialog,
              timing: { duration: 225, easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)' },
            }
          ],
          'exit': [
            {
              name: 'fade-out-animation',
              node: this.$.signInDialog,
              timing: { duration: 50, delay: 140 },
            },
            {
              name: 'slide-down-animation',
              node: this.$.signInDialog,
              timing: { duration: 195, easing: 'cubic-bezier(0.4, 0.0, 1, 1)' },
            }
          ]
        }
      },
      
      attached: function() {
        this.playAnimation('entry');
        this.async(function() {
          if(!this.$.fAuth.user) {
            this.fire('setup-required')
          }
        }, 1000)
      },
      
      setLayout: function() {
        // Enable/disable drawer swiping
        if(this.smallLayout) {
          this.$.drawer.swipeOpen = false;
        } else {
          this.$.drawer.swipeOpen = true;
        };
        // Fix app-layout
        this.$.ironSwipeablePages.parentElement.parentElement.style.paddingTop = this.$.header.offsetHeight + 'px';
        this.$.ironSwipeablePages.style.height = this.offsetHeight - this.$.header.offsetHeight + 'px'
      },
      
      lessonsToday: function(timetable) { // Couses the app to crash
        var day = new Date().getDay();
        day--;
        if(day > timetable.length || day < 0) {
          day = 0
        };
        // Also remember lesson times, but not now...
        return timetable[day];
      },
      
      _onDataChange: function() {
        if(this.data) {
          this.$.loading.active = false;
        };
      },
      
      sendFeedback: function() {
        this.fire('open-help', {target: 'feedback'})
      },
      
      openHelp: function() {
        this.fire('open-help', {target: 'index'})
      },
      
      setup: function() {
        this.$.signInDialog.open();
      },
      
      closeDrawer: function() {
        this.$.drawer.close()
      },
      
      hideFab: function() {
        if(this.$.drawer.opened == true || this.$.optionsButton.opened == true) {
          this.$.fab.parentElement.hidden = true;
          this.$.fabMimic.hidden = false
        } else {
          this.$.fab.parentElement.hidden = false;
          this.$.fabMimic.hidden = true
        }
      },
      
      _signInToFirebase: function() {
        this.$.fAuth.signInWithPopup().then(function() {
          app.$.signInDialog.close();
          app.$.onboarding.open({ authorized: true })
        });
      },
      
      _onSignInClosed: function(e) { // A bit hacky here
        if(typeof e.detail.confirmed !== undefined) { // Not working
          this.$.onboarding.open({ authorized: false })
        }
      },
      
      _onAddDialogCanceled: function(e) {
        e.preventDefault();
        this.$.addDialogCanceled.open();
      },
      
      _onAddDialogClosed: function(e) {
        if(e.detail.confirmed) {
          // Save data from dialog
        } else {
          // Clear data from dialog
        }
      },
      
      _onAddDialogCanceledClosed: function(e) {
        if(e.detail.confirmed) {
          this.$.addDialog.close()
        }
      }
    });
  </script>
</dom-module>