<!--
  To run propeply requires the following:
  - `firebase-app` element must be propely set-up on the page;
  - this element should be a child of node that `app` variable refers to
    you change this by changing the declaration of `thisElem` var
  
  To refresh call `load()` method or change `uid` param
  
  To update data change the `data` param
-->

<dom-module id="yta-database-controller">
  <template>
    <style>
      :host { display: none; }
    </style>
    <app-pouchdb-document db-name="your-timetable"
                          doc-id="data"
                          data="{{cachedData}}">
  </app-pouchdb-document>
  </template>
  
  <script>
    var databaseConfigured = false;
  
    Polymer({
      is: 'yta-database-controller',
      
      properties: {
        
        uid: {
          type: String,
          notify: true,
          observer: 'load'
        },
        
        data: {
          type: Object,
          notify: true
        },
        
        cachedData: {
          type: Object,
          notify: true,
          reflectToAttribute: true,
          value: function() { return {
            lastEdit: 0
          } }
        },
        
        fData: {
          type: Object,
          notify: true,
          value: function() { return {} }
        }
        
      },
      
      observers: [
        'newInput(data, data.timetable, data.settings)'
      ],
      
      /* ready: function() {
        if(this.cachedData) {
          this.set('data', this.cachedData)
        }
      }, */
      
      load: function() {
        var thisElem = app.$.database;
        
        firebase.database().ref(['users', this.uid, 'settings'].join('/'))
          .on('value', function(snapshot){
            thisElem.set('fData.settings', snapshot.val());
            if(databaseConfigured) {
              thisElem.saveToCache()
            }
          });
        firebase.database().ref(['users', this.uid, 'timetable'].join('/'))
          .on('value', function(snapshot){
            thisElem.set('fData.timetable', snapshot.val());
            if(databaseConfigured) {
              thisElem.saveToCache()
            }
          });
        
        firebase.database().ref(['users', this.uid, 'lastEdit'].join('/'))
          .once('value')
          .then(function(snapshot) {
            thisElem.fData.lastEdit = snapshot.val();
          });
        
        var lastEdit = {
          cloud: this.fData.lastEdit,
          local: this.cachedData.lastEdit
        };
        
        if(lastEdit.local > lastEdit.cloud) {
          this.set('fData', this.cachedData);
          this.set('data', this.cachedData);
          this.saveToCloud({fromCache: true});
        } else {
          this.saveToCache();
        };
        
        databaseConfigured = true;
      },
      
      saveToCache: function() {
        this.set('data', this.fData);
        var date = new Date().getTime();
        this.data.lastEdit = date;
        this.set('cachedData', this.data);
        this.fire('data-changed');
      },
      
      saveToCloud: function(config = {fromCache: false}) {
        if(config.fromCache) {
          firebase.database().ref(['users', this.uid].join('/'))
            .set(this.cachedData)
        } else {
          var date = new Date().getTime();
          this.data.lastEdit = date;
          firebase.database().ref(['users', this.uid].join('/'))
            .set(this.data);
          this.saveToCache()
        }
      },
      
      newInput: function() {
        this.saveToCloud()
      }
    });
  </script>
</dom-module>