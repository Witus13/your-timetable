<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-layout/app-layout.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/iron-swipeable-pages/iron-swipeable-pages.html">

<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/paper-styles/color.html">
<link rel="import" href="../bower_components/paper-styles/shadow.html">

<link rel="import" href="../bower_components/neon-animation/neon-animations.html"><!-- Pick only nescessary ones -->
<!-- <link rel="import" href="yta-blow-up-animation.html"> # Not working - workaraound used -->
<link rel="import" href="../bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../bower_components/neon-animation/neon-shared-element-animatable-behavior.html">

<link rel="import" href="yta-firebase.html">
<link rel="import" href="yta-overview-page.html">

<link rel="import" href="yta-common-styles.html">

<dom-module id="yta-main-view">
  <template>
    <style include="yta-common-styles">
    
      @media (min-width: 480px) and (max-width: 960px) and (orientation: landscape), (min-width: 0px) and (max-width: 600px) and (orientation: portrait) {
        
      /*
       * Phone styles
       */
       
        
        
      }
      
      /*
       * Cross-device styles
       */
      
      hr {
        border-width: 1px 0 0 0;
        border-color: var(--divider-color);
      }
      
      iron-swipeable-pages {
        @apply(--layout-fit);
      }
      
      app-drawer {
        --app-drawer-content-container: {
          @apply(--shadow-elevation-16dp);
          /* @note 
          Those two values should only apply on mobile.
          However, the drawer shows only on mobile so to speed
          up the page they're included in cross-platform styles
          */
          max-width: 280px;
          width: calc(100% - 56px);
        }
      }
      
      app-toolbar {
        background-color: var(--primary-color);
        color: white;
        /* opacity: var(--light-primary-opacity) # No need to include this since it defaults to 1 */
      }
      
      [title] {
        @apply(--paper-font-title);
      }
      
      paper-menu::shadow paper-item {
        --paper-item-selected-weight: 400 !important;
        --paper-item-focused-before: {
          background: var(--light-theme-secondary-color) !important;
        };
      }
      paper-menu::shadow paper-item:focus:after {
        background: none !important;
      }
      
      #fab {
        @apply(--shadow-transition);
        color: black;
        --paper-fab-iron-icon: {
          opacity: var(--dark-primary-opacity);
        };
      }
      
      /* From http://stackoverflow.com/questions/1495407/maintain-the-aspect-ratio-of-a-div-with-css */
      #ratioContainer {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%;
        border-bottom: 1px solid var(--divider-color);
        margin-bottom: 8px;
      }
      
      #ratioContainer > iron-image {
        @apply(--layout-fit);
        background-color: var(--paper-deep-purple-100);
      }
      
      #ratioContainer > div:not([scrim]) {
        @apply(--layout-horizontal);
        height: 56px;
        color: #FFFFFF; /* From https://material.google.com/patterns/navigation-drawer.html#navigation-drawer-specs */
        position: absolute;
        left: 16px;
        right: 16px;
        bottom: 8px;
      }
      #ratioContainer > div:not([scrim]) > div {
        @apply(--layout-self-center);
        @apply(--layout-vertical);
        @apply(--layout-flex);
      }
      #ratioContainer > div:not([scrim]) > paper-menu-button {
        @apply(--layout-self-end);
        left: 16px; /* How the hell are those two properties working? */
        top: 8px;
      }
      #ratioContainer > div:not([scrim]) > div > div:not([secondary]) { 
        @apply(--paper-font-body2);
      }
      #ratioContainer > div:not([scrim]) > div > div[secondary] {
        @apply(--paper-font-body1);
      }
      #ratioContainer > div[scrim] {
        @apply(--layout-fit);
        /* Genrated using http://www.cssmatic.com/gradient-generator */
        background: rgba(0,0,0,0);
        background: -moz-linear-gradient(top, rgba(0,0,0,0) 0%, rgba(0,0,0,0.1) 70%, rgba(0,0,0,0.2) 100%);
        background: -webkit-gradient(left top, left bottom, color-stop(0%, rgba(0,0,0,0)), color-stop(70%, rgba(0,0,0,0.1)), color-stop(100%, rgba(0,0,0,0.2)));
        background: -webkit-linear-gradient(top, rgba(0,0,0,0) 0%, rgba(0,0,0,0.1) 70%, rgba(0,0,0,0.2) 100%);
        background: -o-linear-gradient(top, rgba(0,0,0,0) 0%, rgba(0,0,0,0.1) 70%, rgba(0,0,0,0.2) 100%);
        background: -ms-linear-gradient(top, rgba(0,0,0,0) 0%, rgba(0,0,0,0.1) 70%, rgba(0,0,0,0.2) 100%);
        background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.1) 70%, rgba(0,0,0,0.2) 100%);
      }
      
      #drawerMenusContainer::shadow paper-menu::shadow paper-item::shadow iron-icon {
        padding-right: 32px;
        vertical-align: middle;
      }
      #drawerMenusContainer::shadow paper-menu::shadow paper-item:not(.iron-selected)::shadow iron-icon {
        color: var(--secondary-text-color);
      }
      
      #drawerMenusContainer::shadow paper-menu::shadow paper-item {
        font-weight: 500 !important;
        color: var(--primary-text-color);
        --paper-item-selected-weight: 500 !important;
        --paper-item-selected: {
          color: var(--primary-color) !important;
        };
      }
      
      iron-swipeable-pages::shadow div {
        background-color: var(--primary-body-color);
      }
      
      iron-swipeable-pages::shadow div > * {
        @apply(--layout-fit);
      }
      
      iron-swipeable-pages::shadow div > .waiter {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        @apply(--layout-center-justified);
      }
      
      iron-swipeable-pages::shadow div > .waiter > paper-spinner {
        --paper-spinner-stroke-width: 4px;
        position: relative;
        width: 44px;
        height: 44px;
      }
      
    </style>
    
    <yta-firebase data="{{data}}"></yta-firebase>
    
    <app-drawer-layout force-narrow fullbleed>
      <app-drawer id="drawer" swipe-open="[[phoneLayout]]">
        <div id="ratioContainer">
          <iron-image src="../images/paper-cover-photo.png" fade preload></iron-image>
          <div scrim></div>
          <div>
            <div>
              <div>{{user.name}}</div>
              <div secondary>{{user.email}}</div>
            </div>
            <paper-menu-button horizontal-align="right">
              <paper-icon-button icon="arrow-drop-down" class="dropdown-trigger"></paper-icon-button>
              <paper-menu class="dropdown-content">
                <paper-item on-tap="signOut">Log out</paper-item>
              </paper-menu>
            </paper-menu-button>
          </div>
        </div>
        <div id="drawerMenusContainer">
          <paper-menu selected="{{selected}}" on-tap="_closeDrawer" attr-for-selected="key">
            <paper-item key="overview"><iron-icon icon="home"></iron-icon>Overview</paper-item>
            <paper-item key="timetable"><iron-icon icon="timeline"></iron-icon>Timetable</paper-item>
            <paper-item key="teachers"><iron-icon icon="account-balance"></iron-icon>Teachers</paper-item>
            <paper-item key="calendar"><iron-icon icon="event"></iron-icon>Calendar</paper-item>
          </paper-menu>
          <hr noshade>
          <paper-menu on-tap="_closeDrawer" activate-event="">
            <paper-item on-tap="_openSettings"><iron-icon icon="settings"></iron-icon>Settings</paper-item>
            <paper-item on-tap="_sendFeedback"><iron-icon icon="feedback"></iron-icon>Send feedback</paper-item>
            <!--<paper-item key="calendar"><iron-icon icon="help"></iron-icon>Help</paper-item> # Think of help section -->
          </paper-menu>
        </div>
      </app-drawer>
      
      <app-header-layout> 
        <app-header id="header" fixed shadow>
          <app-toolbar>
            <paper-icon-button icon="menu" hidden$="[[!phoneLayout]]" drawer-toggle></paper-icon-button>
            <div title>Your Timetable</div>
            <paper-menu-button hidden$="[[phoneLayout]]" horizontal-align="right">
              <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
              <paper-menu class="dropdown-content">
                <paper-item on-tap="_openSettings">Settings</paper-item>
                <paper-item on-tap="_sendFeedback">Feedback</paper-item>
                <!--<paper-item>Help</paper-item> # Think of help section -->
              </paper-menu>
            </paper-menu-button>
          </app-toolbar>
          <app-toolbar hidden$="[[phoneLayout]]">
            <paper-tabs selected="{{selected}}" attr-for-selected="key" bottom-item>
              <paper-tab key="overview">overview</paper-tab>
              <paper-tab key="timetable">timetable</paper-tab>
              <paper-tab key="teachers">teachers</paper-tab>
              <paper-tab key="calendar">calendar</paper-tab>
            </paper-tabs>
          </app-toolbar>
        </app-header>
        
        <div content>
          <iron-swipeable-pages id="pages"
                                edge-swipe-sensitivity="30"
                                selected="{{selected}}"
                                attr-for-selected="id">
            <div id="overview">
              <yta-overview-page></yta-overview-page>
              <div class="waiter">
                <paper-spinner active></paper-spinner>
              </div>
            </div>
            <div id="timetable">
              <yta-timetable-page></yta-timetable-page>
              <div class="waiter">
                <paper-spinner active></paper-spinner>
              </div>
            </div>
            <div id="teachers">
              <yta-teachers-page></yta-teachers-page>
              <div class="waiter">
                <paper-spinner active></paper-spinner>
              </div>
            </div>
            <div id="calendar">
              <yta-calendar-page></yta-calendar-page>
              <div class="waiter">
                <paper-spinner active></paper-spinner>
              </div>
            </div>
          </iron-swipeable-pages>
          <paper-fab id="fab" icon="add" on-tap="_openAddDialog"></paper-fab>
        </div>
      </app-header-layout>
    </app-drawer-layout>
  </template>
  
  <script>
    Polymer({
      is: 'yta-main-view',
      
      behaviors: [
        Polymer.NeonSharedElementAnimatableBehavior,
        Polymer.NeonAnimationRunnerBehavior,
        Polymer.IronResizableBehavior
      ],
      
      properties: {
        
        phoneLayout: {
          type: Boolean,
          notify: true
        },
        
        selected: {
          type: String,
          notify: true,
          reflectToAttribute: true,
          value: 'overview',
          observer: 'resolveSelected'
        },
        
        data: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },
        
        user: {
          type: Object,
          notify: true,
          reflectToAttribute: true,
          value: function() { return {
            signedIn: false,
            name: 'Your name',
            email: 'you@example.com',
            imageUrl: 'https://placehold.it/64?text=You'
          } }
          
        },
        
        animationConfig: {
          value: function() { return {
            'ready': [
              {
                name: 'fade-in-animation',
                node: this.$.pages,
                timing: {
                  duration: 500,
                  easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
                }
              },
              {
                name: 'scale-up-animation',
                node: this.$.fab,
                timing: {
                  duration: 500,
                  easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
                }
              },
              {
                name: 'slide-from-top-animation',
                node: this.$.header,
                timing: {
                  duration: 500,
                  easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
                }
              }
            ],
            'fadeOut': {
              name: 'fade-out-animation'
            }
          } }
        }
        
      },
      
      listeners: {
        'iron-resize': 'setLayout', // To set the layout when screen size changes
        'drawer.app-drawer-transitioned': '_onDrawerTransitioned' // To keep focus in drawer when open
      },
      
      attached: function() {
        appmain = this;
        this.setLayout();
        this.playAnimation('ready');
      },
      
      setLayout: function() {
        // Fix app-layout
        var screenSpace = this.offsetHeight - this.$.header.offsetHeight + 'px';
        this.querySelector('div[content]').style.height = screenSpace;
        this.$.pages.style.height = screenSpace;
        this.$.pages.style.paddingTop = this.$.header.offsetHeight + 'px';
        // Set addDialog animation timing
        if(addDialog) {
          if(shell.desktopLayout) {
            addDialog.$.cancel.animationConfig.entry[0].timing.duration = 150;
            addDialog.$.cancel.animationConfig.entry[1].timing.duration = 150;
            addDialog.$.cancel.animationConfig.exit[0].timing.duration = 120;
            addDialog.$.cancel.animationConfig.exit[1].timing.duration = 120;
          } else {
            addDialog.$.cancel.animationConfig.entry[0].timing.duration = 225;
            addDialog.$.cancel.animationConfig.entry[1].timing.duration = 225;
            addDialog.$.cancel.animationConfig.exit[0].timing.duration = 195;
            addDialog.$.cancel.animationConfig.exit[1].timing.duration = 195;
          }
        }
      },
      
      signOut: function() {
        firebaseControl.signOut();
      },
      
      resolveSelected: function(selectedString) {
        if(selectedString != 'overview') {
          selectedItemWaiter = appmain.$.pages.querySelector(['#', selectedString, ' > .waiter'].join(''));
          if(!selectedItemWaiter.hidden) {
            this.importHref(['src/yta', selectedString, 'page.html'].join('-'), function() {
              appmain.set('animationConfig.fadeOut.node', selectedItemWaiter);
              appmain.listen(appmain, 'neon-animation-finish', '_hideSelectedItemWaiter');
              appmain.playAnimation('fadeOut');
            }, null, true);
          }
        }
      },
      
      _openAddDialog: function() {
        // Import element
        this.importHref('src/yta-add-dialog.html', function() {
          /*// Define shared elents
          if(!shell.desktopLayout) {
            appmain.sharedElements = {
              'hero': appmain.$.fab
            };
          };
        
          // Set to-dialog transition
          var output = [];
          if(!shell.desktopLayout) {
            output.push({
              name: 'hero-animation',
              id: 'hero',
              timing: {
                duration: 300, // Default for phone
                easing: 'cubic-bezier(0.4, 0.0, 0.2, 1)'
              },
              fromPage: appmain
            });
            if(shell.tabletLayout) {
              output[0].timing.duration = 390;
            };
          } else {
            output.push({
              name: 'scale-down-animation',
              node: appmain.$.fab,
              timing: {
                duration: 100,
                easing: 'cubic-bezier(0.4, 0.0, 1, 1)'
              }
            });
          };
          appmain.set('animationConfig.exit', output);
          
          var output = [];
          if(!shell.phoneLayout) {
            output.push({
              name: 'fade-in-animation',
              node: addDialog.$.backdrop,
              timing: {
                duration: 150, // Default for desktop
                easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
              }
            });
            if(shell.tabletLayout) {
              output[0].timing.duration = 390;
            };
          };
          if(!shell.desktopLayout) {
            output.push({
              name: 'hero-animation',
              id: 'hero',
              toPage: addDialog
            })
          } else {
            output.push({
              name: 'slide-from-bottom-animation',
              node: addDialog.$.dialog,
              timing: {
                duration: 150,
                easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
              }
            });
            output.push({
              name: 'fade-in-animation',
              node: addDialog.$.dialog,
              timing: {
                duration: 150,
                easing: 'cubic-bezier(0.0, 0.0, 0.2, 1)'
              }
            });
          };
          addDialog.set('animationConfig.entry', output)*/
          if(shell.desktopLayout) {
            addDialog.$.cancel.animationConfig.entry[0].timing.duration = 150;
            addDialog.$.cancel.animationConfig.entry[1].timing.duration = 150;
            addDialog.$.cancel.animationConfig.exit[0].timing.duration = 120;
            addDialog.$.cancel.animationConfig.exit[1].timing.duration = 120;
          } else {
            addDialog.$.cancel.animationConfig.entry[0].timing.duration = 225;
            addDialog.$.cancel.animationConfig.entry[1].timing.duration = 225;
            addDialog.$.cancel.animationConfig.exit[0].timing.duration = 195;
            addDialog.$.cancel.animationConfig.exit[1].timing.duration = 195;
          }
          // Set from-dialog transition
          //..
          // Switch pages
          this.fire('switch-page', { action: 'openAddDialog' });
          
        }, null, true);
      },
      
      _hideSelectedItemWaiter: function() {
        selectedItemWaiter.hidden = true;
        this.unlisten(this, 'neon-animation-finish', '_hideSelectedItemWaiter')
      },
      
      _onDrawerTransitioned: function(e) {
        //..
      },
      
      _sendFeedback: function() {
        console.log('Feedback request sent');
        this.fire('send-feedback');
      },
      
      _openSettings: function() {
        console.log('Open settings request sent');
        this.fire('open-settings');
      },
      
      _closeDrawer: function() {
        this.$.drawer.close()
      }
    })
  </script>
</dom-module>