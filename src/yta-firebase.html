<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">

<link rel="import" href="../bower_components/polymerfire/polymerfire.html">

<dom-module id="yta-firebase">
  <template>
    <style>
      :host { display: none; }
    </style>
    
    <app-pouchdb-document id="cache"
                          db-name="your-timetable"
                          doc-id="[[user.uid]]"
                          data="{{cachedData}}"></app-pouchdb-document>
    
    <firebase-app auth-domain="your-timetable.firebaseapp.com"
                  database-url="https://your-timetable.firebaseio.com"
                  api-key="AIzaSyDaMune3u4WZMti3aB66FWjX9aA_lWTLkQ"></firebase-app>
    <firebase-auth id="auth" 
                   user="{{user}}"
                   auth="{{auth}}"
                   provider="google"></firebase-auth>
  </template>
  
  <script>
    Polymer({
      is: 'yta-firebase',
      
      properties: {
        
        user: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },
        
        /*auth: {
          type: Object,
          notify: true,
          reflectToAttribute: true
        },*/
        
        data: {
          type: Object,
          notify: true
        },
        
        cachedData: {
          type: Object,
          notify: true,
          reflectToAttribute: true,
          value: function() { return {
            lastEdit: 0
          } }
        },
        
        fData: {
          type: Object,
          notify: true,
          reflectToAttribute: true,
          value: function() { return {} }
        }
        
      },
      
      observers: [
        'authLoaded(user)'
      ],
      
      attached: function() {
        firebaseControl = this;
      },
      
      signIn: function() {
        this.$.auth.signInWithPopup()
          .then(function(response) {
            //..
          })
          .catch(function(error) {
            //..
          });
      },
      
      signOut: function() {
        this.$.auth.signOut()
          .then(function(response) {
            //..
          })
          .catch(function(error) {
            //..
          });
      },
      
      authLoaded: function(userObject) {
        if(userObject == null || !userObject.isDefault) {
          if(!userObject) {
            console.log('Not logged in, opening onboarding');
            this.importHref('src/yta-onboarding.html', function() {
              this.fire('switch-page', { action: 'openOnboarding' });
            }, null, true);
          }
        }
      }
    });
  </script>
</dom-module>